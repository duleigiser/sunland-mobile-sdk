/**
* @sunl-fe/mobile-live-sdk
* @version 2.2.1
* @date 2020-03-31 15:33:36
*/
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self).SLIVE=e()}(this,(function(){var t="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function e(t,e){return t(e={exports:{}},e.exports),e.exports}var n=e((function(t){var e=Object.prototype.hasOwnProperty,n="~";function i(){}function o(t,e,n){this.fn=t,this.context=e,this.once=n||!1}function r(t,e,i,r,s){if("function"!=typeof i)throw new TypeError("The listener must be a function");var a=new o(i,r||t,s),c=n?n+e:e;return t._events[c]?t._events[c].fn?t._events[c]=[t._events[c],a]:t._events[c].push(a):(t._events[c]=a,t._eventsCount++),t}function s(t,e){0==--t._eventsCount?t._events=new i:delete t._events[e]}function a(){this._events=new i,this._eventsCount=0}Object.create&&(i.prototype=Object.create(null),(new i).__proto__||(n=!1)),a.prototype.eventNames=function(){var t,i,o=[];if(0===this._eventsCount)return o;for(i in t=this._events)e.call(t,i)&&o.push(n?i.slice(1):i);return Object.getOwnPropertySymbols?o.concat(Object.getOwnPropertySymbols(t)):o},a.prototype.listeners=function(t){var e=n?n+t:t,i=this._events[e];if(!i)return[];if(i.fn)return[i.fn];for(var o=0,r=i.length,s=new Array(r);o<r;o++)s[o]=i[o].fn;return s},a.prototype.listenerCount=function(t){var e=n?n+t:t,i=this._events[e];return i?i.fn?1:i.length:0},a.prototype.emit=function(t,e,i,o,r,s){var a=n?n+t:t;if(!this._events[a])return!1;var c,l,u=this._events[a],h=arguments.length;if(u.fn){switch(u.once&&this.removeListener(t,u.fn,void 0,!0),h){case 1:return u.fn.call(u.context),!0;case 2:return u.fn.call(u.context,e),!0;case 3:return u.fn.call(u.context,e,i),!0;case 4:return u.fn.call(u.context,e,i,o),!0;case 5:return u.fn.call(u.context,e,i,o,r),!0;case 6:return u.fn.call(u.context,e,i,o,r,s),!0}for(l=1,c=new Array(h-1);l<h;l++)c[l-1]=arguments[l];u.fn.apply(u.context,c)}else{var d,p=u.length;for(l=0;l<p;l++)switch(u[l].once&&this.removeListener(t,u[l].fn,void 0,!0),h){case 1:u[l].fn.call(u[l].context);break;case 2:u[l].fn.call(u[l].context,e);break;case 3:u[l].fn.call(u[l].context,e,i);break;case 4:u[l].fn.call(u[l].context,e,i,o);break;default:if(!c)for(d=1,c=new Array(h-1);d<h;d++)c[d-1]=arguments[d];u[l].fn.apply(u[l].context,c)}}return!0},a.prototype.on=function(t,e,n){return r(this,t,e,n,!1)},a.prototype.once=function(t,e,n){return r(this,t,e,n,!0)},a.prototype.removeListener=function(t,e,i,o){var r=n?n+t:t;if(!this._events[r])return this;if(!e)return s(this,r),this;var a=this._events[r];if(a.fn)a.fn!==e||o&&!a.once||i&&a.context!==i||s(this,r);else{for(var c=0,l=[],u=a.length;c<u;c++)(a[c].fn!==e||o&&!a[c].once||i&&a[c].context!==i)&&l.push(a[c]);l.length?this._events[r]=1===l.length?l[0]:l:s(this,r)}return this},a.prototype.removeAllListeners=function(t){var e;return t?(e=n?n+t:t,this._events[e]&&s(this,e)):(this._events=new i,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=n,a.EventEmitter=a,t.exports=a}));const i="undefined"!=typeof window?window:{},o=t=>{const e=t.length,n=new Array(e);for(let i=0;i<e;i++)n[i]=t[i];return n},r=(t,e,n)=>{const i=t.length;if(void 0!==i&&void 0===t.nodeType)for(let o=0;o<i;o++)e.call(n,t[o],o,t);else e.call(n,t,0,t);return t},s=(t,...e)=>(e.forEach(e=>{for(let n in e)t[n]=e[n]}),t),a=t=>t.filter((e,n)=>t.indexOf(e)===n);let c=!1;const l=/^\s*<(\w+|!)[^>]*>/,u=/^<(\w+)\s*\/?>(?:<\/\1>|)$/,h=/^[.#]?[\w-]*$/,d=function(t,e=document){let n;if(t){if(t instanceof E)return t;"string"!=typeof t?n=t.nodeType||t===window?[t]:t:l.test(t)?n=m(t):(e="string"==typeof e?document.querySelector(e):e.length?e[0]:e,n=v(t,e))}else n=document.querySelectorAll(null);return _(n)},p=function(t){const e=[];return r(this,n=>r(v(t,n),t=>{-1===e.indexOf(t)&&e.push(t)})),d(e)},f=(()=>{const t="undefined"!=typeof Element?Element.prototype:i,e=t.matches||t.matchesSelector||t.mozMatchesSelector||t.msMatchesSelector||t.oMatchesSelector||t.webkitMatchesSelector;return(t,n)=>e.call(t,n)})(),v=(t,e)=>{if(h.test(t)){if("#"===t[0]){const n=(e.getElementById?e:document).getElementById(t.slice(1));return n?[n]:[]}return"."===t[0]?e.getElementsByClassName(t.slice(1)):e.getElementsByTagName(t)}return e.querySelectorAll(t)},m=t=>{if(u.test(t))return[document.createElement(RegExp.$1)];const e=[],n=document.createElement("div"),i=n.childNodes;n.innerHTML=t;for(let o=0,r=i.length;o<r;o++)e.push(i[o]);return e},_=t=>(c||(E.prototype=d.fn,E.prototype.constructor=E,c=!0),new E(t)),E=function(t){let e=0;const n=t.length;for(;e<n;)this[e]=t[e++];this.length=n};var y=Object.freeze({__proto__:null,$:d,find:p,matches:f,DOMtastic:E});const g=Array.prototype,S=g.every,T=function(t,e){return r(this,t,e)},k=T,O=g.indexOf,I=g.map,L=g.pop,w=g.push,b=g.reduce,C=g.reduceRight,R=g.shift,A=g.some,P=g.unshift;var D=Object.freeze({__proto__:null,every:S,filter:function(t,e){const n="function"==typeof t?t:e=>f(e,t);return d(g.filter.call(this,n,e))},forEach:T,each:k,indexOf:O,map:I,pop:L,push:w,reduce:b,reduceRight:C,reverse:function(){return d(o(this).reverse())},shift:R,some:A,unshift:P});function M(t){class e{constructor(){E.call(this,d(...arguments))}}return s(e.prototype,t),e}const N=t=>t.replace(/-([\da-z])/gi,(t,e)=>e.toUpperCase()),x=t=>t.replace(/([a-z\d])([A-Z])/g,"$1-$2").toLowerCase();var H=Object.freeze({__proto__:null,css:function(t,e){let n,i,o;if("string"==typeof t){if(t=N(t),void 0===e){let e=this.nodeType?this:this[0];return e?(o=e.style[t],(t=>!isNaN(parseFloat(t))&&isFinite(t))(o)?parseFloat(o):o):void 0}n={},n[t]=e}else for(i in n=t,n)o=n[i],delete n[i],n[N(i)]=o;return r(this,t=>{for(i in n)n[i]||0===n[i]?t.style[i]=n[i]:t.style.removeProperty(x(i))}),this}});const W=Array.prototype.forEach,V=function(t){if(this instanceof Node)if("string"==typeof t)this.insertAdjacentHTML("beforeend",t);else if(t instanceof Node)this.appendChild(t);else{const e=t instanceof NodeList?o(t):t;W.call(e,this.appendChild.bind(this))}else U(this,V,t);return this},F=function(t){if(this instanceof Node)if("string"==typeof t)this.insertAdjacentHTML("afterbegin",t);else if(t instanceof Node)this.insertBefore(t,this.firstChild);else{let e=t instanceof NodeList?o(t):t;W.call(e.reverse(),F.bind(this))}else U(this,F,t);return this},q=function(t){if(this instanceof Node)if("string"==typeof t)this.insertAdjacentHTML("beforebegin",t);else if(t instanceof Node)this.parentNode.insertBefore(t,this);else{const e=t instanceof NodeList?o(t):t;W.call(e,q.bind(this))}else U(this,q,t);return this},j=function(t){if(this instanceof Node)if("string"==typeof t)this.insertAdjacentHTML("afterend",t);else if(t instanceof Node)this.parentNode.insertBefore(t,this.nextSibling);else{const e=t instanceof NodeList?o(t):t;W.call(e.reverse(),j.bind(this))}else U(this,j,t);return this},G=t=>"string"==typeof t?t:t instanceof Node?t.cloneNode(!0):"length"in t?[].map.call(t,t=>t.cloneNode(!0)):t,U=(t,e,n)=>{let i=t.length;for(;i--;){const o=0===i?n:G(n);e.call(t[i],o)}};var K=Object.freeze({__proto__:null,append:V,prepend:F,before:q,after:j,clone:function(){return d(G(this))},_clone:G,_each:U});var B=Object.freeze({__proto__:null,attr:function(t,e){if("string"==typeof t&&void 0===e){const e=this.nodeType?this:this[0];return e?e.getAttribute(t):void 0}return r(this,n=>{if("object"==typeof t)for(let e in t)n.setAttribute(e,t[e]);else n.setAttribute(t,e)})},removeAttr:function(t){return r(this,e=>e.removeAttribute(t))}});const Y=function(t,e){return r(this,n=>n.classList[t](e))};var z=Object.freeze({__proto__:null,addClass:function(t){return t&&t.length&&r(t.split(" "),Y.bind(this,"add")),this},removeClass:function(t){return t&&t.length&&r(t.split(" "),Y.bind(this,"remove")),this},toggleClass:function(t,e){if(t&&t.length){const n="boolean"==typeof e?e?"add":"remove":"toggle";r(t.split(" "),Y.bind(this,n))}return this},hasClass:function(t){return(this.nodeType?[this]:this).some(e=>e.classList.contains(t))}});const $=(t,e)=>!(!t||!e||t===e)&&(t.contains?t.contains(e):!!t.compareDocumentPosition&&!(t.compareDocumentPosition(e)&Node.DOCUMENT_POSITION_DISCONNECTED));var J=Object.freeze({__proto__:null,contains:$});const X="undefined"!=typeof document&&"dataset"in document.documentElement,Q=X?"dataset":"__DOMTASTIC_DATA__",Z=t=>t.replace(/-+(.)?/g,(t,e)=>e?e.toUpperCase():"");var tt=Object.freeze({__proto__:null,data:function(t,e){if("string"==typeof t&&void 0===e){const e=this.nodeType?this:this[0];return e&&Q in e?e[Q][Z(t)]:void 0}return r(this,n=>{X||(n[Q]=n[Q]||{}),n[Q][Z(t)]=e})},prop:function(t,e){if("string"==typeof t&&void 0===e){const e=this.nodeType?this:this[0];return e&&e?e[t]:void 0}return r(this,n=>n[t]=e)}});var et=Object.freeze({__proto__:null,appendTo:function(t){const e="string"==typeof t?d(t):t;return V.call(e,this),this},empty:function(){return r(this,t=>t.innerHTML="")},remove:function(){return r(this,t=>{t.parentNode&&t.parentNode.removeChild(t)})},replaceWith:function(){return q.apply(this,arguments).remove()},text:function(t){return void 0===t?this[0].textContent:r(this,e=>e.textContent=""+t)},val:function(t){return void 0===t?this.length>0?this[0].value:void 0:r(this,e=>e.value=t)}});var nt=Object.freeze({__proto__:null,html:function(t){if(void 0===t){const t=this.nodeType?this:this[0];return t?t.innerHTML:void 0}return r(this,e=>e.innerHTML=t)}});const it=(()=>{const t=function(t,e){const n=[];return r(this,i=>{for(;i&&i!==e;){if(f(i,t)){n.push(i);break}i=i.parentElement}}),d(a(n))};return"undefined"!=typeof Element&&Element.prototype.closest?function(e,n){if(n)return t.call(this,e,n);{const t=[];return r(this,n=>{const i=n.closest(e);i&&t.push(i)}),d(a(t))}}:t})();var ot=Object.freeze({__proto__:null,closest:it});const rt=function(t,e,n,i,o){let s,a,c;return"function"==typeof e&&(n=e,e=null),t.split(" ").forEach(l=>{s=l.split("."),l=s[0]||null,a=s[1]||null,c=pt(n),r(this,r=>{if(e&&(c=Et.bind(r,e,c)),o){const o=c;c=s=>{st.call(r,t,e,n,i),o.call(r,s)}}r.addEventListener(l,c,i||!1),ht(r).push({eventName:l,handler:n,eventListener:c,selector:e,namespace:a})})},this),this},st=function(t="",e,n,i){let o,s,a;return"function"==typeof e&&(n=e,e=null),t.split(" ").forEach(t=>(o=t.split("."),t=o[0]||null,s=o[1]||null,r(this,o=>{a=ht(o),r(a.filter(i=>!(t&&i.eventName!==t||s&&i.namespace!==s||n&&i.handler!==n||e&&i.selector!==e)),t=>{o.removeEventListener(t.eventName,t.eventListener,i||!1),a.splice(a.indexOf(t),1)}),t||s||e||n?0===a.length&&dt(o):dt(o)})),this),this},at="__domtastic_event__";let ct=1,lt={},ut=[];const ht=t=>{t[at]||(t[at]=0===ut.length?++ct:ut.pop());const e=t[at];return lt[e]||(lt[e]=[])},dt=t=>{const e=t[at];lt[e]&&(lt[e]=null,t[at]=null,ut.push(e))},pt=t=>(function(e){return t.call(this,_t(e))}),ft={preventDefault:"isDefaultPrevented",stopImmediatePropagation:"isImmediatePropagationStopped",stopPropagation:"isPropagationStopped"},vt=()=>!0,mt=()=>!1,_t=t=>{if(!t.isDefaultPrevented||t.stopImmediatePropagation||t.stopPropagation){for(const e in ft)!function(e,n,i){t[e]=function(){return this[n]=vt,i&&i.apply(this,arguments)},t[n]=mt}(e,ft[e],t[e]);t._preventDefault&&t.preventDefault()}return t},Et=function(t,e,n){const i=n._target||n.target,o=it.call([i],t,this)[0];o&&o!==this&&(o!==i&&n.isPropagationStopped&&n.isPropagationStopped()||e.call(o,n))},yt=rt,gt=st;var St=Object.freeze({__proto__:null,on:rt,off:st,one:function(t,e,n,i){return rt.call(this,t,e,n,i,1)},getHandlers:ht,clearHandlers:dt,proxyHandler:pt,delegateHandler:Et,bind:yt,unbind:gt});const Tt=/^(mouse(down|up|over|out|enter|leave|move)|contextmenu|(dbl)?click)$/,kt=/^key(down|press|up)$/,Ot=function(t,e,{bubbles:n=!0,cancelable:i=!0,preventDefault:o=!1}={}){const s=new(It(t))(t,{bubbles:n,cancelable:i,preventDefault:o,detail:e});return s._preventDefault=o,r(this,r=>{!n||Rt||Lt(r)?Ct(r,s):wt(r,t,{bubbles:n,cancelable:i,preventDefault:o,detail:e})})},It=t=>At?Tt.test(t)?MouseEvent:kt.test(t)?KeyboardEvent:CustomEvent:CustomEvent,Lt=t=>t===window||t===document||$(t.ownerDocument.documentElement,t),wt=(t,e,n={})=>{n.bubbles=!1;const i=new CustomEvent(e,n);i._target=t;do{Ct(t,i)}while(t=t.parentNode)},bt=["blur","focus","select","submit"],Ct=(t,e)=>{-1===bt.indexOf(e.type)||"function"!=typeof t[e.type]||e._preventDefault||e.cancelable?t.dispatchEvent(e):t[e.type]()};(()=>{const t=function(t,e={bubbles:!1,cancelable:!1,detail:void 0}){let n=document.createEvent("CustomEvent");return n.initCustomEvent(t,e.bubbles,e.cancelable,e.detail),n};t.prototype=i.CustomEvent&&i.CustomEvent.prototype,i.CustomEvent=t})();const Rt=(()=>{let t=!1;const e=i.document;if(e){const n=e.createElement("div"),i=n.cloneNode();n.appendChild(i),n.addEventListener("e",(function(){t=!0})),i.dispatchEvent(new CustomEvent("e",{bubbles:!0}))}return t})(),At=(()=>{try{new MouseEvent("click")}catch(t){return!1}return!0})();var Pt=Object.freeze({__proto__:null,trigger:Ot,triggerHandler:function(t,e){this[0]&&Ot.call(this[0],t,e,{bubbles:!1,preventDefault:!0})}});var Dt=Object.freeze({__proto__:null,ready:function(t){return/complete|loaded|interactive/.test(document.readyState)&&document.body?t():document.addEventListener("DOMContentLoaded",t,!1),this}});const Mt=i.$;var Nt=Object.freeze({__proto__:null,noConflict:function(){return i.$=Mt,this}});const xt=function(t,e){return d([].slice.apply(this,arguments))};var Ht=Object.freeze({__proto__:null,children:function(t){const e=[];return r(this,n=>{n.children&&r(n.children,n=>{(!t||t&&f(n,t))&&e.push(n)})}),d(e)},concat:function(t){return r(d(t),t=>{-1===[].indexOf.call(this,t)&&[].push.call(this,t)}),this},contents:function(){const t=[];return r(this,e=>t.push.apply(t,o(e.childNodes))),d(t)},eq:function(t){return xt.call(this,t,t+1)},first:function(){return xt.call(this,0,1)},get:function(t){return this[t]},parent:function(t){const e=[];return r(this,n=>{(!t||t&&f(n.parentNode,t))&&e.push(n.parentNode)}),d(e)},siblings:function(t){const e=[];return r(this,n=>r(n.parentNode.children,i=>{i!==n&&(!t||t&&f(i,t))&&e.push(i)})),d(e)},slice:xt});const Wt=Array.isArray;var Vt=Object.freeze({__proto__:null,isFunction:t=>"function"==typeof t,isArray:Wt});const Ft={};let qt={};void 0!==y&&(qt=d,qt.matches=f,Ft.find=p),s(qt,J,Nt,Vt),s(Ft,D,H,B,K,z,tt,et,nt,St,Pt,Dt,ot,Ht),qt.fn=Ft,qt.version="__VERSION__",qt.extend=s,qt.BaseClass=M(qt.fn);var jt=qt,Gt={TT_PATH:1,TT_SOLID_LINE:2,TT_DASH_LINE:3,TT_ARROW_LINE:4,TT_RECT:5,TT_ELLIPSE:6,TT_TEXT:7},Ut={RTMP_PROTOCOL:1,FLV_PROTOCOL:2,HLS_PROTOCOL:3},Kt={READY:1,LIVE:2,PAUSE:3,END:4},Bt={EC_KICK_BY_ADMIN:10034,EC_ROOM_REPEAT_LOGIN:10008},Yt={CMT_BEGIN_LIVE:1,CMT_END_LIVE:2,CMT_HEARTBEAT:3,CMT_PAGE_CHANGE:4,CMT_ADD_TRACE:5,CMT_ERASE_TRACE:6,CMT_DOWNLOAD_DOCUMENT:7,CMT_CREATE_TABULA:8,CMT_LOGIN_REQUEST:9,CMT_DESTROY_TABULA:10,CMT_VIDEO_BEGIN:5e3,CMT_GET_PAGE:5001,CMT_GET_INCREAMENT_MSG:5002,CMT_VIDEO_END:8e3,SMT_LOGIN_REPLY:10001,SMT_LOGIN_NOTIFY:10002,SMT_BEGIN_LIVE:10003,SMT_END_LIVE:10004,SMT_HEARTBEAT:10005,SMT_ADD_TRACE:10006,SMT_ERASE_TRACE:10007,SMT_PAGE_CHANGE_NOTIFY:10008,SMT_DOCUMENT_INFO:10009,SMT_ERROR:10010,SMT_VIDEO_LOGIN_RES:10011,SMT_VIDEO_BATCH_RES:10012,SMT_CHANGE_CDN_NOTIFY:10015,SMT_PAUSE_LIVE_NOTIFY:10016,SMT_CONTINUE_LIVE_NOTIFY:10017,SMT_BEGIN_PAPER_NOTIFY:10018,SMT_SCROLL_POSITION:10021,SMT_PROMOTE:10026,SMT_BEGIN_RAFFLE_INFO:10027,SMT_RAFFLE_RESULT:10028},zt=Kt;function $t(t){return"string"==typeof t?document.getElementById(t):t}function Jt(t){return new Promise((function(e){return setTimeout(e,t)}))}function Xt(t){return t?new Promise((function(e,n){var i=new Image;i.onload=e,i.onerror=n,i.src=t})):Promise.resolve()}var Qt='\n<div class="sl-camera-status-mask">\n    <span class="sl-camera-status-mask-text"></span>\n</div>\n',Zt='\n<div class="sl-sketchpad-status-mask">\n    <span class="sl-sketchpad-status-mask-text"></span>\n</div>\n';function te(t,e){var n=t.camera,i=t.sketchpad,o=jt(n.el).find(".sl-camera-status-mask"),r=jt(i.el).find(".sl-sketchpad-status-mask");switch(o.remove(),r.remove(),e){case zt.READY:jt(n.el).find(".sl-camera-container").append(Qt).find(".sl-camera-status-mask-text").text("直播未开始~"),jt(i.el).find(".sp-container").append(Zt).find(".sl-sketchpad-status-mask-text").text("直播未开始~");break;case zt.PAUSE:jt(n.el).find(".sl-camera-container").append(Qt).find(".sl-camera-status-mask-text").text("直播已暂停~"),jt(i.el).find(".sp-container").append(Zt).find(".sl-sketchpad-status-mask-text").text("直播已暂停~");break;case zt.END:jt(n.el).find(".sl-camera-container").append(Qt).find(".sl-camera-status-mask-text").text("直播已结束~"),jt(i.el).find(".sp-container").append(Zt).find(".sl-sketchpad-status-mask-text").text("直播已结束~")}}var ee=function(){return(new Date).toLocaleTimeString()},ne=localStorage.getItem("LOGGER_LEVEL")||3;console.log("当前日志级别",ne);var ie,oe={error:function(){if(4>=ne){for(var t,e=arguments.length,n=new Array(e),i=0;i<e;i++)n[i]=arguments[i];(t=console).error.apply(t,["[ERROR]"+ee()+"："].concat(n))}},warn:function(){if(3>=ne){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];(console.warn||console.log).apply(void 0,["[WARN]"+ee()+"："].concat(e))}},info:function(){if(2>=ne){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];(console.info||console.log).apply(void 0,["[INFO]"+ee()+"："].concat(e))}},debug:function(){if(1>=ne){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];(console.debug||console.log).apply(void 0,["[DEBUG]"+ee()+"："].concat(e))}}},re=e((function(e,n){!function(e){function n(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function o(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function r(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var n=[],i=!0,o=!1,r=void 0;try{for(var s,a=t[Symbol.iterator]();!(i=(s=a.next()).done)&&(n.push(s.value),!e||n.length!==e);i=!0);}catch(c){o=!0,r=c}finally{try{i||null==a.return||a.return()}finally{if(o)throw r}}return n}(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function s(t){return function(t){if(Array.isArray(t)){for(var e=0,n=new Array(t.length);e<t.length;e++)n[e]=t[e];return n}}(t)||function(t){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}
/*! @source http://purl.eligrey.com/github/classList.js/blob/master/classList.js */
"document"in window.self&&("classList"in document.createElement("_")&&(!document.createElementNS||"classList"in document.createElementNS("http://www.w3.org/2000/svg","g"))||function(t){if("Element"in t){var e=t.Element.prototype,n=Object,i=String.prototype.trim||function(){return this.replace(/^\s+|\s+$/g,"")},o=Array.prototype.indexOf||function(t){for(var e=0,n=this.length;e<n;e++)if(e in this&&this[e]===t)return e;return-1},r=function(t,e){this.name=t,this.code=DOMException[t],this.message=e},s=function(t,e){if(""===e)throw new r("SYNTAX_ERR","An invalid or illegal string was specified");if(/\s/.test(e))throw new r("INVALID_CHARACTER_ERR","String contains an invalid character");return o.call(t,e)},a=function(t){for(var e=i.call(t.getAttribute("class")||""),n=e?e.split(/\s+/):[],o=0,r=n.length;o<r;o++)this.push(n[o]);this._updateClassName=function(){t.setAttribute("class",this.toString())}},c=a.prototype=[],l=function(){return new a(this)};if(r.prototype=Error.prototype,c.item=function(t){return this[t]||null},c.contains=function(t){return-1!==s(this,t+="")},c.add=function(){var t,e=arguments,n=0,i=e.length,o=!1;do{t=e[n]+"",-1===s(this,t)&&(this.push(t),o=!0)}while(++n<i);o&&this._updateClassName()},c.remove=function(){var t,e,n=arguments,i=0,o=n.length,r=!1;do{for(t=n[i]+"",e=s(this,t);-1!==e;)this.splice(e,1),r=!0,e=s(this,t)}while(++i<o);r&&this._updateClassName()},c.toggle=function(t,e){t+="";var n=this.contains(t),i=n?!0!==e&&"remove":!1!==e&&"add";return i&&this[i](t),!0===e||!1===e?e:!n},c.toString=function(){return this.join(" ")},n.defineProperty){var u={get:l,enumerable:!0,configurable:!0};try{n.defineProperty(e,"classList",u)}catch(h){void 0!==h.number&&-2146823252!==h.number||(u.enumerable=!1,n.defineProperty(e,"classList",u))}}else n.prototype.__defineGetter__&&e.__defineGetter__("classList",l)}}(window.self),function(){var t=document.createElement("_");if(t.classList.add("c1","c2"),!t.classList.contains("c2")){var e=function(t){var e=DOMTokenList.prototype[t];DOMTokenList.prototype[t]=function(t){var n,i=arguments.length;for(n=0;n<i;n++)t=arguments[n],e.call(this,t)}};e("add"),e("remove")}if(t.classList.toggle("c3",!1),t.classList.contains("c3")){var n=DOMTokenList.prototype.toggle;DOMTokenList.prototype.toggle=function(t,e){return 1 in arguments&&!this.contains(t)==!e?e:n.call(this,t)}}t=null}());var a="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0!==t?t:"undefined"!=typeof self?self:{};function c(t,e){return t(e={exports:{}},e.exports),e.exports}var l="Expected a function",u=NaN,h="[object Symbol]",d=/^\s+|\s+$/g,p=/^[-+]0x[0-9a-f]+$/i,f=/^0b[01]+$/i,v=/^0o[0-7]+$/i,m=parseInt,_="object"==typeof a&&a&&a.Object===Object&&a,E="object"==typeof self&&self&&self.Object===Object&&self,y=_||E||Function("return this")(),g=Object.prototype.toString,S=Math.max,T=Math.min,k=function(){return y.Date.now()};function O(t){var e=typeof t;return!!t&&("object"==e||"function"==e)}function I(t){if("number"==typeof t)return t;if(function(t){return"symbol"==typeof t||function(t){return!!t&&"object"==typeof t}(t)&&g.call(t)==h}(t))return u;if(O(t)){var e="function"==typeof t.valueOf?t.valueOf():t;t=O(e)?e+"":e}if("string"!=typeof t)return 0===t?t:+t;t=t.replace(d,"");var n=f.test(t);return n||v.test(t)?m(t.slice(2),n?2:8):p.test(t)?u:+t}var L=function(t,e,n){var i,o,r,s,a,c,u=0,h=!1,d=!1,p=!0;if("function"!=typeof t)throw new TypeError(l);function f(e){var n=i,r=o;return i=o=void 0,u=e,s=t.apply(r,n)}function v(t){var n=t-c;return void 0===c||n>=e||n<0||d&&t-u>=r}function m(){var t=k();if(v(t))return _(t);a=setTimeout(m,function(t){var n=e-(t-c);return d?T(n,r-(t-u)):n}(t))}function _(t){return a=void 0,p&&i?f(t):(i=o=void 0,s)}function E(){var t=k(),n=v(t);if(i=arguments,o=this,c=t,n){if(void 0===a)return function(t){return u=t,a=setTimeout(m,e),h?f(t):s}(c);if(d)return a=setTimeout(m,e),f(c)}return void 0===a&&(a=setTimeout(m,e)),s}return e=I(e)||0,O(n)&&(h=!!n.leading,r=(d="maxWait"in n)?S(I(n.maxWait)||0,e):r,p="trailing"in n?!!n.trailing:p),E.cancel=function(){void 0!==a&&clearTimeout(a),u=0,i=c=o=a=void 0},E.flush=function(){return void 0===a?s:_(k())},E};function w(){return document.scrollingElement||document.documentElement}function b(t){return t.pageX-w().scrollLeft}function C(t){return t.pageY-w().scrollTop}function R(){return"".concat(Date.now().toString().substring(5)).concat(Math.floor(1e3*Math.random()))}function A(t){t instanceof Array&&4===t.length||console.error("colorToCSSString failed, color=",t);var e=r(t,4),n=e[0],i=e[1],o=e[2],s=e[3];return"rgba(".concat(n,", ").concat(i,", ").concat(o,", ").concat((s/255).toFixed(2),")")}var P=function(){function t(e){var i=this;n(this,t),o(this,"createSketchpad",(function(t){var e=t.screenWidth,n=t.screenHeight,o=t.slideWidth,r=t.slideHeight,s='\n            <div class="sp-container">\n                <div class="sp-screen" style="width: '.concat(e,"px; height: ").concat(n,'px">\n                    <div class="sp-scroll">\n                        <div class="sp-slide" style="width: ').concat(o,"px; height: ").concat(r,'px">\n                        </div>\n                        <canvas\n                            width="').concat(o,'"\n                            height="').concat(r,'"\n                            class="sp-canvas"\n                            style="width: ').concat(o,"px; height: ").concat(r,'px"\n                        ></canvas>\n                        <div class="sp-text" contenteditable="true"></div>\n                    </div>\n                    <div class="sp-scrollbar"></div>\n                    \n                </div>\n            </div>\n            \n        ');i.rootEle.innerHTML=s})),o(this,"setScreenSize",(function(t,e){if(!i.compare("screenWidth",t)||!i.compare("screenHeight",e)){var n=i.rootEle.querySelector(".sp-screen");n.style.width="".concat(t,"px"),n.style.height="".concat(e,"px"),i.save("screenWidth",t),i.save("screenHeight",e)}})),o(this,"setSlideSize",(function(t,e){if(!i.compare("slideWidth",t)||!i.compare("slideHeight",e)){var n=i.rootEle.querySelector(".sp-slide");n.style.width="".concat(t,"px"),n.style.height="".concat(e,"px");var o=i.rootEle.querySelector(".sp-canvas");o.style.width="".concat(t,"px"),o.style.height="".concat(e,"px"),o.width=t,o.height=e,i.save("slideWidth",t),i.save("slideHeight",e)}})),o(this,"setSlideImage",(function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",e=arguments.length>1?arguments[1]:void 0;if(!i.compare("imageSource",t)||!i.compare("slideColor",e)){var n=i.rootEle.querySelector(".sp-slide");n.style.backgroundImage="url('".concat(t.trim(),"')"),n.style.backgroundColor=A(e),i.save("imageSource",t),i.save("slideColor",e)}})),o(this,"setScrollBar",(function(t,e,n){if(!(i.compare("scrollBarVisible",t)&&i.compare("scrollBarTop",e)&&i.compare("scrollBarHeight",n))){var o=i.rootEle.querySelector(".sp-scrollbar");t?(o.style.top="".concat(e,"px"),o.style.height="".concat(n,"px"),o.style.display="block"):o.style.display="none",i.save("scrollBarVisible",t),i.save("scrollBarTop",e),i.save("scrollBarHeight",n)}})),o(this,"scrollSlide",(function(t){if(!i.compare("scrollTop",t)){var e=i.rootEle.querySelector(".sp-scroll");e.scrollHeight>e.clientHeight?(e.scrollTop=t,e.style.top=0):(e.style.top="".concat(-t,"px"),e.scrollTop=0),i.save("scrollTop",t)}})),o(this,"setInteractive",(function(t){if(!i.compare("interactive",t)){var e=i.rootEle.querySelector(".sp-screen");t?e.classList.add("interactive"):e.classList.remove("interactive"),i.save("interactive",t)}})),o(this,"setMode",(function(t){var e="mode-".concat(t);if(!i.compare("modeClass",e)){for(var n=i.rootEle.querySelector(".sp-screen"),o="",r=0;r<n.classList.length;r+=1)if(0===n.classList[r].indexOf("mode-")){o=n.classList[r];break}o&&n.classList.remove(o),n.classList.add(e),i.save("modeClass",e)}})),this.rootEle=e,this.domSnapshot={screenWidth:null,screenHeight:null,slideWidth:null,slideHeight:null,imageSource:null,slideColor:null,scrollBarVisible:null,scrollBarTop:null,scrollBarHeight:null,scrollTop:null,interactive:null,modeClass:null}}var e,r,s;return e=t,(r=[{key:"compare",value:function(t,e){return this.domSnapshot[t]===e}},{key:"save",value:function(t,e){this.domSnapshot[t]=e}}])&&i(e.prototype,r),s&&i(e,s),t}(),D=[6,4],M=[255,0,0,255],N=1e4,x=N/1e3*4,H=N/1e3*80;function W(t,e,n){t.save();var i=e.type;"path"===i?function(t,e,n){var i=e.points,o=e.dash,r=e.color,s=void 0===r?M:r,a=e.width,c=void 0===a?x:a;t.beginPath();for(var l=0;l<i.length;l+=2){var u=q(i[l],n),h=j(i[l+1],n);0===l?t.moveTo(u,h):t.lineTo(u,h)}o&&t.setLineDash(D),t.strokeStyle=A(s),t.lineWidth=q(c,n),t.stroke()}(t,e,n):"rect"===i?function(t,e,n){var i=e.points,o=e.color,r=void 0===o?M:o,s=e.width,a=void 0===s?x:s;t.beginPath(),t.rect(q(i[0],n),j(i[1],n),q(i[2],n)-q(i[0],n),j(i[3],n)-j(i[1],n)),t.strokeStyle=A(r),t.lineWidth=q(a,n),t.stroke()}(t,e,n):"text"===i?function(t,e,n){var i=e.points,o=e.color,r=e.fontSize,s=void 0===r?H:r,a=e.text;t.beginPath();var c=q(i[0],n),l=j(i[1],n),u=q(i[2],n),h=j(i[3],n),d=a.split("\n"),p=(h-l)/d.length;t.fillStyle=A(o),t.font="".concat(j(s,n),"px Arial"),t.textBaseline="top",d.forEach((function(e,n){t.fillText(e,c,l+p*n,u-c)}))}(t,e,n):"arrow"===i?function(t,e,n){var i=e.points,o=e.color,r=void 0===o?M:o,s=e.width,a=void 0===s?x:s,c=q(i[0],n),l=j(i[1],n),u=q(i[2],n),h=j(i[3],n);!function(t,e,n,i,o,r,s){var a=[0,0,-7,r/2,-12,r/2+3];t.beginPath(),t.strokeStyle=s,t.fillStyle=s;var c=i-e,l=o-n,u=Math.sqrt(c*c+l*l),h=l/u,d=c/u,p=[];p.push(0,0);for(var f=0;f<a.length;f+=2){var v=a[f],m=a[f+1];p.push(v<0?u+v:v,m)}for(p.push(u,0),f=a.length;f>0;f-=2)v=a[f-2],m=a[f-1],p.push(v<0?u+v:v,-m);for(p.push(0,0),f=0;f<p.length;f+=2)v=p[f]*d-p[f+1]*h+e,m=p[f]*h+p[f+1]*d+n,0===f?t.moveTo(v,m):t.lineTo(v,m);t.stroke(),t.fill()}(t,c,l,u,h,q(a,n),A(r))}(t,e,n):"ellipse"===i?function(t,e,n){var i=e.points,o=e.color,r=void 0===o?M:o,s=e.width,a=void 0===s?x:s,c=q(i[0],n),l=j(i[1],n),u=q(i[2],n),h=j(i[3],n),d=c+(u-c)/2,p=l+(h-l)/2,f=Math.abs((u-c)/2),v=Math.abs((h-l)/2),m=f>v?1/f:1/v;t.beginPath(),t.moveTo(d+f,p);for(var _=0;_<2*Math.PI;_+=m)t.lineTo(d+f*Math.cos(_),p+v*Math.sin(_));t.strokeStyle=A(r),t.lineWidth=q(a,n),t.closePath(),t.stroke()}(t,e,n):console.warn("unsupported shape",e),t.restore()}function V(t,e){if(null==t)return t;var n=e.slideWidth;return Math.ceil(t*N/n)}function F(t,e){if(null==t)return t;var n=e.slideHeight;return Math.ceil(t*N/n)}function q(t,e){if(null==t)return t;var n=e.slideWidth;return Math.ceil(t*n/N)}function j(t,e){if(null==t)return t;var n=e.slideHeight;return Math.ceil(t*n/N)}var G=c((function(t){!function(){function e(t,e,n){var i=e.x,o=e.y,r=n.x-i,s=n.y-o;if(0!==r||0!==s){var a=((t.x-i)*r+(t.y-o)*s)/(r*r+s*s);a>1?(i=n.x,o=n.y):a>0&&(i+=r*a,o+=s*a)}return(r=t.x-i)*r+(s=t.y-o)*s}function n(t,n){var i=t.length-1,o=[t[0]];return function t(n,i,o,r,s){for(var a,c=r,l=i+1;l<o;l++){var u=e(n[l],n[i],n[o]);u>c&&(a=l,c=u)}c>r&&(a-i>1&&t(n,i,a,r,s),s.push(n[a]),o-a>1&&t(n,a,o,r,s))}(t,0,i,n,o),o.push(t[i]),o}function i(t,e,i){if(t.length<=2)return t;var o=void 0!==e?e*e:1;return t=n(t=i?t:function(t,e){for(var n,i,o,r,s,a=t[0],c=[a],l=1,u=t.length;l<u;l++)n=t[l],o=a,r=void 0,s=void 0,r=(i=n).x-o.x,s=i.y-o.y,r*r+s*s>e&&(c.push(n),a=n);return a!==n&&c.push(n),c}(t,o),o)}t.exports=i,t.exports.default=i}()})),U="Expected a function",K=NaN,B="[object Symbol]",Y=/^\s+|\s+$/g,z=/^[-+]0x[0-9a-f]+$/i,$=/^0b[01]+$/i,J=/^0o[0-7]+$/i,X=parseInt,Q="object"==typeof a&&a&&a.Object===Object&&a,Z="object"==typeof self&&self&&self.Object===Object&&self,tt=Q||Z||Function("return this")(),et=Object.prototype.toString,nt=Math.max,it=Math.min,ot=function(){return tt.Date.now()};function rt(t,e,n){var i,o,r,s,a,c,l=0,u=!1,h=!1,d=!0;if("function"!=typeof t)throw new TypeError(U);function p(e){var n=i,r=o;return i=o=void 0,l=e,s=t.apply(r,n)}function f(t){var n=t-c;return void 0===c||n>=e||n<0||h&&t-l>=r}function v(){var t=ot();if(f(t))return m(t);a=setTimeout(v,function(t){var n=e-(t-c);return h?it(n,r-(t-l)):n}(t))}function m(t){return a=void 0,d&&i?p(t):(i=o=void 0,s)}function _(){var t=ot(),n=f(t);if(i=arguments,o=this,c=t,n){if(void 0===a)return function(t){return l=t,a=setTimeout(v,e),u?p(t):s}(c);if(h)return a=setTimeout(v,e),p(c)}return void 0===a&&(a=setTimeout(v,e)),s}return e=at(e)||0,st(n)&&(u=!!n.leading,r=(h="maxWait"in n)?nt(at(n.maxWait)||0,e):r,d="trailing"in n?!!n.trailing:d),_.cancel=function(){void 0!==a&&clearTimeout(a),l=0,i=c=o=a=void 0},_.flush=function(){return void 0===a?s:m(ot())},_}function st(t){var e=typeof t;return!!t&&("object"==e||"function"==e)}function at(t){if("number"==typeof t)return t;if(function(t){return"symbol"==typeof t||function(t){return!!t&&"object"==typeof t}(t)&&et.call(t)==B}(t))return K;if(st(t)){var e="function"==typeof t.valueOf?t.valueOf():t;t=st(e)?e+"":e}if("string"!=typeof t)return 0===t?t:+t;t=t.replace(Y,"");var n=$.test(t);return n||J.test(t)?X(t.slice(2),n?2:8):z.test(t)?K:+t}var ct=function(t,e,n){var i=!0,o=!0;if("function"!=typeof t)throw new TypeError(U);return st(n)&&(i="leading"in n?!!n.leading:i,o="trailing"in n?!!n.trailing:o),rt(t,e,{leading:i,maxWait:e,trailing:o})},lt=new(c((function(t){!function(e){function n(){}var i=n.prototype,o=e.EventEmitter;function r(t,e){for(var n=t.length;n--;)if(t[n].listener===e)return n;return-1}function s(t){return function(){return this[t].apply(this,arguments)}}i.getListeners=function(t){var e,n,i=this._getEvents();if(t instanceof RegExp)for(n in e={},i)i.hasOwnProperty(n)&&t.test(n)&&(e[n]=i[n]);else e=i[t]||(i[t]=[]);return e},i.flattenListeners=function(t){var e,n=[];for(e=0;e<t.length;e+=1)n.push(t[e].listener);return n},i.getListenersAsObject=function(t){var e,n=this.getListeners(t);return n instanceof Array&&((e={})[t]=n),e||n},i.addListener=function(t,e){if(!function t(e){return"function"==typeof e||e instanceof RegExp||!(!e||"object"!=typeof e)&&t(e.listener)}(e))throw new TypeError("listener must be a function");var n,i=this.getListenersAsObject(t),o="object"==typeof e;for(n in i)i.hasOwnProperty(n)&&-1===r(i[n],e)&&i[n].push(o?e:{listener:e,once:!1});return this},i.on=s("addListener"),i.addOnceListener=function(t,e){return this.addListener(t,{listener:e,once:!0})},i.once=s("addOnceListener"),i.defineEvent=function(t){return this.getListeners(t),this},i.defineEvents=function(t){for(var e=0;e<t.length;e+=1)this.defineEvent(t[e]);return this},i.removeListener=function(t,e){var n,i,o=this.getListenersAsObject(t);for(i in o)o.hasOwnProperty(i)&&-1!==(n=r(o[i],e))&&o[i].splice(n,1);return this},i.off=s("removeListener"),i.addListeners=function(t,e){return this.manipulateListeners(!1,t,e)},i.removeListeners=function(t,e){return this.manipulateListeners(!0,t,e)},i.manipulateListeners=function(t,e,n){var i,o,r=t?this.removeListener:this.addListener,s=t?this.removeListeners:this.addListeners;if("object"!=typeof e||e instanceof RegExp)for(i=n.length;i--;)r.call(this,e,n[i]);else for(i in e)e.hasOwnProperty(i)&&(o=e[i])&&("function"==typeof o?r.call(this,i,o):s.call(this,i,o));return this},i.removeEvent=function(t){var e,n=typeof t,i=this._getEvents();if("string"===n)delete i[t];else if(t instanceof RegExp)for(e in i)i.hasOwnProperty(e)&&t.test(e)&&delete i[e];else delete this._events;return this},i.removeAllListeners=s("removeEvent"),i.emitEvent=function(t,e){var n,i,o,r,s=this.getListenersAsObject(t);for(r in s)if(s.hasOwnProperty(r))for(n=s[r].slice(0),o=0;o<n.length;o++)!0===(i=n[o]).once&&this.removeListener(t,i.listener),i.listener.apply(this,e||[])===this._getOnceReturnValue()&&this.removeListener(t,i.listener);return this},i.trigger=s("emitEvent"),i.emit=function(t){var e=Array.prototype.slice.call(arguments,1);return this.emitEvent(t,e)},i.setOnceReturnValue=function(t){return this._onceReturnValue=t,this},i._getOnceReturnValue=function(){return!this.hasOwnProperty("_onceReturnValue")||this._onceReturnValue},i._getEvents=function(){return this._events||(this._events={})},n.noConflict=function(){return e.EventEmitter=o,n},t.exports?t.exports=n:e.EventEmitter=n}("undefined"!=typeof window?window:a||{})})));function ut(t,e){lt.on(t,e)}function ht(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];lt.emit.apply(lt,[t].concat(n))}var dt="scroll",pt="add_tracks",ft="remove_tracks",vt="clear_tracks",mt=function(){var t=!1,e=!1,n=[],i=null,o=0,r=0,s=[],a=ct((function(t){ht(pt,{type:pt,tracks:[{points:_t(t.points),type:"path",width:t.currentWidth,color:t.currentColor,id:i}]}),t.points.splice(0,Math.max(t.points.length-2,0))}),250,{leading:!1});return function(c,l){if(l.interactive&&"path"===l.mode){var u=l.currentWidth,h=l.currentColor,d=l.ctx,p=l.context,f=l.stack,v=l.generateId,m=0,_=0;if(d.strokeStyle=A(h),d.lineWidth=q(u,p),"mousedown"===c.type){var E=l.canvas.getBoundingClientRect(),y=E.left,g=E.top;o=y,r=g,i=v(),t=!0,m=b(c)-o,_=C(c)-r,d.beginPath(),d.moveTo(m,_),n=[V(m,p),F(_,p)],s=[V(m,p),F(_,p)]}else"mousemove"===c.type?t&&(e=!0,m=b(c)-o,_=C(c)-r,d.lineTo(m,_),d.stroke(),n.push(V(m,p),F(_,p)),s.push(V(m,p),F(_,p)),a({points:s,currentWidth:u,currentColor:h})):"mouseup"!==c.type&&"mouseout"!==c.type||t&&(t=!1,e&&f.addTrack({points:_t(n),type:"path",width:u,color:h,id:i},!1),e=!1)}}}();function _t(t){for(var e=[],n=[],i=0;i<t.length;i+=2)e.push({x:t[i],y:t[i+1]});return G(e,15,!0).forEach((function(t){n.push(t.x),n.push(t.y)})),n}var Et,yt=function(){var t=!1,e=null,n=0,i=0,r=0,s=0;return function(a,c){if(c.interactive&&"rect"===c.mode){var l=c.currentWidth,u=c.currentColor,h=c.ctx,d=c.context,p=c.stack,f=c.paint,v=c.generateId;if(h.strokeStyle=A(u),h.lineWidth=q(l,d),"mousedown"===a.type){var m=c.canvas.getBoundingClientRect(),_=m.left,E=m.top;r=_,s=E,e=v(),t=!0,n=b(a)-r,i=C(a)-E}else if("mousemove"===a.type){if(t){var y=b(a)-r,g=C(a)-s;c.clearTemp(),c.addTemp({id:e,type:"rect",width:l,color:u,points:[V(n,d),F(i,d),V(y,d),F(g,d)]}),f()}}else if(("mouseup"===a.type||"mouseout"===a.type)&&t&&(t=!1,c.tempShapes.length>0)){var S=function(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{},i=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(i=i.concat(Object.getOwnPropertySymbols(n).filter((function(t){return Object.getOwnPropertyDescriptor(n,t).enumerable})))),i.forEach((function(e){o(t,e,n[e])}))}return t}({},c.tempShapes[0]);c.clearTemp(),p.addTrack(S)}}}}(),gt=(Et={inTexting:!1,x:0,y:0},function(t,e){"click"===t.type&&Et.inTexting&&(function(t,e){var n=t.context,i=t.currentColor,o=t.currentFontSize,r=t.ctx,s=t.stack,a=t.generateId,c=t.ele.querySelector(".sp-text"),l=j(o,n),u=c.innerText.replace(/(\r\n)+/g,"\n").trim();if(u.trim()){r.font="".concat(l,"px Arial");var h=r.measureText(u).width,d=j(o*u.split("\n").length,n),p=V(e.x,n),f=F(e.y,n),v=V(e.x+h,n),m=F(e.y+d,n),_={id:a(),type:"text",points:[p,f,v,m],fontSize:o,color:i,text:u};s.addTrack(_)}c.classList.remove("show"),c.innerHTML=""}(e,Et),Et.inTexting=!1),e.interactive&&"text"===e.mode&&("click"!==t.type||Et.inTexting||t.target!==e.canvas||(Et.inTexting=!0,function(t,e,n){var i=t.context,o=t.currentColor,r=t.currentFontSize,s=t.ele.querySelector(".sp-text"),a=j(r,i),c=t.canvas.getBoundingClientRect(),l=c.left,u=c.top,h=c.width,d=c.height;e.x=b(n)-l,e.y=C(n)-u,s.classList.add("show"),s.style.left="".concat(e.x,"px"),s.style.top="".concat(e.y,"px"),s.style.fontSize="".concat(a,"px"),s.style.color=A(o),s.style.maxWidth="".concat(h-e.x-10,"px"),s.style.maxHeight="".concat(d-e.y-2,"px"),s.style.borderColor=A(o),s.focus()}(e,Et,t)))}),St=function t(e){var i=this;n(this,t),o(this,"_undoStack",[]),o(this,"_redoStack",[]),o(this,"clearStack",(function(){i._undoStack=[],i._redoStack=[]})),o(this,"pushUndoStack",(function(t){i._undoStack.length>=30&&i._undoStack.splice(0,1),i._undoStack.push(t)})),o(this,"pushRedoStack",(function(t){i._redoStack.length>=30&&i._redoStack.splice(0,1),i._redoStack.push(t)})),o(this,"undo",(function(){var t=i._undoStack.pop();if(t){i.pushRedoStack(t);var e=t.operation,n=t.data;if("addTrack"===e)n.id||console.warn("no id for the track",n),i._removeTracksWithEvent([n.id]);else{if("clearTrack"!==e)throw new Error("no defined action");i._addTracksWithEvent(n)}}})),o(this,"redo",(function(){var t=i._redoStack.pop();if(t){i.pushUndoStack(t);var e=t.operation,n=t.data;if("addTrack"===e)i._addTracksWithEvent([n]);else{if("clearTrack"!==e)throw new Error("no defined action");var o=n.map((function(t){return t.id}));i._clearTracksWithEvent(o)}}})),o(this,"_addTracksWithEvent",(function(t){var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];t.forEach((function(t){i.track.add(t)})),i.track.paint(),e&&ht(pt,{type:pt,tracks:t})})),o(this,"_removeTracksWithEvent",(function(t){t.forEach((function(t){i.track.removeById(t)})),i.track.paint(),ht(ft,{type:ft,tracksId:t})})),o(this,"_clearTracksWithEvent",(function(t){i.track.clear(),i.track.paint(),ht(vt,{type:vt,tracksId:t})})),o(this,"addTrack",(function(t){var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];i._redoStack=[],i.pushUndoStack({operation:"addTrack",data:t}),i._addTracksWithEvent([t],e)})),o(this,"clearTrack",(function(){if(i.track.shapes&&0!==i.track.shapes.length){i._redoStack=[],i.pushUndoStack({operation:"clearTrack",data:s(i.track.shapes)});var t=i.track.shapes.map((function(t){return t.id}));i._clearTracksWithEvent(t)}})),this.track=e},Tt=function t(e){var i=this,r=e.ele,a=e.context,c=e.sketchpad;n(this,t),o(this,"setIdGenerationStrategy",(function(t){if(!t||"function"!=typeof t)throw new Error("invalid idGenStrategy function");i.generateId=t})),o(this,"addEvents",(function(){i.canvas.addEventListener("mousedown",i._onEvents),i.canvas.addEventListener("mousemove",i._onEvents),i.canvas.addEventListener("mouseup",i._onEvents),i.canvas.addEventListener("mouseout",i._onEvents),document.addEventListener("click",i._onEvents)})),o(this,"removeEvents",(function(){i.canvas.removeEventListener("mousedown",i._onEvents),i.canvas.removeEventListener("mousemove",i._onEvents),i.canvas.removeEventListener("mouseup",i._onEvents),i.canvas.removeEventListener("mouseout",i._onEvents),document.removeEventListener("click",i._onEvents)})),o(this,"dispose",(function(){i.removeEvents()})),o(this,"setBrush",(function(t){var e=t.width,n=t.color;if(n&&4!==n.length)throw new Error("color must be defined as array [r, g, b, a]");i.currentWidth=e,i.currentColor=n})),o(this,"setFontSize",(function(t){i.currentFontSize=t})),o(this,"_onEvents",(function(t){mt(t,i),yt(t,i),gt(t,i)})),o(this,"interact",(function(t){i.interactive=t})),o(this,"setMode",(function(t){i.mode=t})),o(this,"add",(function(t){t.id||console.warn("no id",t),i.shapes=i.shapes.concat(t)})),o(this,"setShapes",(function(t){i.shapes=s(t)})),o(this,"removeById",(function(t){i.shapes=i.shapes.filter((function(e){return e.id!==t}))})),o(this,"clear",(function(){i.shapes=[]})),o(this,"addTemp",(function(t){i.tempShapes=i.tempShapes.concat(t)})),o(this,"clearTemp",(function(){i.tempShapes=[]})),o(this,"paint",(function(){!function(t,e){t.clearRect(0,0,e.slideWidth,e.slideHeight)}(i.ctx,i.context),i.shapes.forEach((function(t){W(i.ctx,t,i.context)})),i.tempShapes.forEach((function(t){W(i.ctx,t,i.context)})),i.sketchpad.sketchpadDom.setMode(i.mode)})),this.ele=r,this.canvas=this.ele.querySelector(".sp-canvas"),this.ctx=this.canvas.getContext("2d"),this.shapes=[],this.tempShapes=[],this.context=a,this.sketchpad=c,this.addEvents(),this.interactive=!1,this.mode="path",this.currentWidth=x,this.currentColor=M,this.currentFontSize=H,this.stack=new St(this),this.generateId=R};e.Sketchpad=function t(e){var i,r=this,s=e.ele;n(this,t),o(this,"init",(function(){window.addEventListener("resize",r.debouncedResize),r.updateScreenSize(),r.updateSlideSize();var t=r.context,e=t.screenWidth,n=t.screenHeight,i=t.slideWidth,o=t.slideHeight;r.sketchpadDom=new P(r.ele),r.sketchpadDom.createSketchpad({screenWidth:e,screenHeight:n,slideWidth:i,slideHeight:o}),r.track=new Tt({ele:r.ele,context:r.context,sketchpad:r}),document.addEventListener("mousedown",r.handleScrollBar),document.addEventListener("mousemove",r.handleScrollBar),document.addEventListener("mouseup",r.handleScrollBar),r.ele.querySelector(".sp-screen").addEventListener("mousewheel",r.onScroll),r.ele.querySelector(".sp-screen").addEventListener("DOMMouseScroll",r.onScroll)})),o(this,"dispose",(function(){window.removeEventListener("resize",r.debouncedResize),document.removeEventListener("mousedown",r.handleScrollBar),document.removeEventListener("mousemove",r.handleScrollBar),document.removeEventListener("mouseup",r.handleScrollBar),r.ele.querySelector(".sp-screen").removeEventListener("mousewheel",r.onScroll),r.ele.querySelector(".sp-screen").removeEventListener("DOMMouseScroll",r.onScroll),r.track.dispose()})),o(this,"on",(function(){ut.apply(void 0,arguments)})),o(this,"emitScrollChange",(function(t){ht(dt,{type:dt,scroll:t})})),o(this,"interact",(function(t){r.interactive=t,r.track.interact(t)})),o(this,"handleScrollBar",(function(){var t=!1,e=0,n=0,i=null;return function(o){if(r.interactive){var s=o.type,a=o.pageY,c=o.target;if("mousedown"===s&&c===r.ele.querySelector(".sp-scrollbar"))i=c,t=!0,e=a,n=r.context.scroll,i.classList&&i.classList.add("dragging");else if("mousemove"===s&&t){var l=a-e,u=r.context,h=u.screenHeight,d=100*l/(h-h*h/u.slideHeight),p=Math.floor(n+d);(p=(p=p>100?100:p)<0?0:p)!==r.context.scroll&&(r.setScroll(p),r.emitScrollChange(p),r.paint())}else"mouseup"===s&&t&&(t=!1,i.classList&&i.classList.remove("dragging"))}}})),o(this,"onScroll",(function(t){t.preventDefault(),t.stopPropagation();var e=-t.wheelDelta||(t.detail?20*t.detail:null);null!==e&&r.interactive&&(r.context.screenHeight>=r.context.slideHeight||r.context.scroll>=100&&e>0||r.context.scroll<=0&&e<0||window.requestAnimationFrame((function(){var t=Math.floor(.05*e+r.context.scroll);t=(t=t>100?100:t)<0?0:t,r.setScroll(t),r.emitScrollChange(t),r.paint()})))})),o(this,"updateScreenSize",(function(){var t=r.ele,e=t.offsetWidth,n=t.offsetHeight,i=e/n,o=e,s=n;r.context.screenRatio>=i?s=o/r.context.screenRatio:o=s*r.context.screenRatio,r.context.screenHeight=s,r.context.screenWidth=o})),o(this,"updateSlideSize",(function(){r.context.slideWidth=r.context.screenWidth,r.context.slideHeight=r.context.screenWidth/r.context.slideRatio})),o(this,"setSlideRatio",(function(t){r.context.slideRatio=t})),o(this,"setScreenRatio",(function(t){r.context.screenRatio=t})),o(this,"setSlide",(function(t){r.context.slide=t})),o(this,"setSlideColor",(function(t){if(!t||4!==t.length)throw new Error("color must be defined as array [r, g, b, a]");r.context.slideColor=t})),o(this,"setScroll",(function(t){var e=0;t<0?(e=0,console.warn("scroll value must great than 0 and less than 100")):t>100?(e=100,console.warn("scroll value must great than 0 and less than 100")):e=Math.floor(t),r.context.scroll=e})),o(this,"resize",(function(){r.paint()})),o(this,"paint",(function(){r.updateScreenSize(),r.updateSlideSize();var t=r.context,e=t.scroll,n=t.slide,i=t.slideColor,o=t.slideWidth,s=t.slideHeight,a=t.screenWidth,c=t.screenHeight;r.sketchpadDom.setScreenSize(a,c),r.sketchpadDom.setSlideSize(o,s),r.sketchpadDom.setSlideImage(n,i);var l=(s>c?e:50)*(s-c)/100;if(r.sketchpadDom.scrollSlide(l),r.interactive&&s>c){var u=c*c/s,h=e*(c-u)/100;r.sketchpadDom.setScrollBar(!0,h,u)}else r.sketchpadDom.setScrollBar(!1);r.sketchpadDom.setInteractive(r.interactive),r.track.paint()})),this.ele="string"==typeof(i=s)?document.getElementById(i):i,this.context={screenRatio:4/3,slideRatio:1,screenWidth:0,screenHeight:0,slideWidth:0,slideHeight:0,slide:"",slideColor:[255,255,255,0],scroll:50},this.interactive=!1,this.debouncedResize=L(this.resize,100),this.emitScrollChange=L(this.emitScrollChange,200),this.handleScrollBar=this.handleScrollBar()},Object.defineProperty(e,"__esModule",{value:!0})}(n)})),se=(ie=re)&&ie.__esModule&&Object.prototype.hasOwnProperty.call(ie,"default")?ie.default:ie,ae={REPLAY_SERVICE:"video.sunlands.com",LIVE_SERVICE:"live.sunlands.com",IM_SERVICE:"liveim.sunlands.com",REPORT_SERVICE:"caton-report-live.sunlands.com"},ce=10,le=18,ue=1e3,he=4e4,de=4e4,pe=700,fe=4e3,ve=se.Sketchpad;function me(t){var e=t.el,n=t.report;this.el=$t(e),this.sketchpad=null,this.coursewareId=null,this.pageId=null,this.slideUrl=null,this.report=n}function _e(t){var e=function(t){return Object.keys(t).filter((function(e){var n=t[e];return null!=n})).map((function(e){return[e,t[e]].map(encodeURIComponent).join("=")})).join("&")}(arguments.length>1&&void 0!==arguments[1]?arguments[1]:{});return fetch(e?t+"?"+e:t).then((function(t){return t.json()}))}function Ee(t,e){return fetch(t,{cache:"no-cache",body:e,method:"POST",headers:{"content-type":"application/json; charset=utf-8"}}).then((function(t){return t.json()}))}me.prototype.mount=function(){this.sketchpad=new ve({ele:this.el}),this.sketchpad.init(),this.sketchpad.interact(!1),jt(this.el).find(".sp-container").append('\n    <div class="sp-mask sp-mask-error">\n        <div class="sp-mask-icon"></div>\n        <div class="sp-mask-text">课件加载失败，点击重试...</div>\n    </div>\n'),jt(this.el).find(".sp-container").append('\n    <div class="sp-mask sp-mask-loading">\n        <div class="sp-mask-icon"></div>\n        <div class="sp-mask-text">课件加载中...</div>\n    </div>\n'),jt(this.el).find(".sp-container").append('\n    <div class="sp-mask sp-mask-play show">\n        <div class="sp-mask-icon"></div>\n        <div class="sp-mask-text"></div>\n    </div>\n'),this.initEvent()},me.prototype.unmount=function(){this.sketchpad&&(this.sketchpad.dispose(),this.sketchpad=null)},me.prototype.switch=function(t){var e=this,n=t.screenRatio,i=t.slideRatio,o=t.slide,r=t.slideColor,s=t.shapes,a=void 0===s?[]:s,c=t.scroll,l=t.pageId,u=t.coursewareId;this.sketchpad.setScreenRatio(n),this.sketchpad.setSlideRatio(i),this.sketchpad.setSlide(o),this.sketchpad.setSlideColor(r),this.sketchpad.track.stack.clearTrack(),a.forEach((function(t){return e.sketchpad.track.stack.addTrack(t)})),this.sketchpad.setScroll(c),this.coursewareId=u,this.pageId=l,this._checkImage(o),this._report(o)},me.prototype.addTrack=function(t){var e=t.coursewareId,n=t.pageId,i=t.shape;this._checkCourseware(e,n)?this.sketchpad.track.stack.addTrack(i):oe.warn("添加的轨迹不属于当前页，放弃添加")},me.prototype.removeTrack=function(t){var e=this,n=t.coursewareId,i=t.pageId,o=t.shapeIds,r=void 0===o?[]:o;this._checkCourseware(n,i)?r.forEach((function(t){e.sketchpad.track.removeById(t)})):oe.warn("删除的轨迹不属于当前页，放弃删除")},me.prototype.scroll=function(t){var e=t.coursewareId,n=t.pageId,i=t.scroll;this._checkCourseware(e,n)?this.sketchpad.setScroll(i):oe.warn("课件滚动操作不属于当前页，放弃滚动")},me.prototype.paint=function(){this.sketchpad.paint()},me.prototype.resize=function(){this.sketchpad.resize()},me.prototype._checkCourseware=function(t,e){return t===this.coursewareId&&e===this.pageId||(oe.warn("coursewareid or pageid not matched, will ignore.\n            recvCoursewareId:"+t+", currentCoursewareId: "+this.coursewareId+"\n            recvPageId:"+e+", currentPageId: "+this.pageId),!1)},me.prototype.updatePlayingStatus=function(t){jt(this.el).find(".sp-mask-play").toggleClass("show",!t)},me.prototype.onClickPlay=function(t){var e=this;jt(this.el).find(".sp-mask-play")[0].addEventListener("click",(function(n){e.updatePlayingStatus(!0),t()}))},me.prototype._report=function(t){var e=this;if(this.report){if(t){var n=this.coursewareId,i=this.pageId,o=Date.now();Xt(t).then((function(){var r=Date.now()-o;r>=200&&e.report.imageStuck({uri:t,loadTime:r,pageId:i,courseId:n})})).catch((function(){e.report.imageError({loadTime:Date.now()-o,uri:t,pageId:i,courseId:n})}))}}else oe.debug("白板组件未初始化report，跳过打点")},me.prototype._checkImage=function(t){var e=this;if(this.slideUrl=t,t){var n=setTimeout((function(){jt(e.el).find(".sp-mask-error").toggleClass("show",!1),jt(e.el).find(".sp-mask-loading").toggleClass("show",!0)}),100);Xt(t).then((function(){e.slideUrl===t&&(clearTimeout(n),jt(e.el).find(".sp-mask-error").toggleClass("show",!1),jt(e.el).find(".sp-mask-loading").toggleClass("show",!1))})).catch((function(){e.slideUrl===t&&(clearTimeout(n),jt(e.el).find(".sp-mask-error").toggleClass("show",!0),jt(e.el).find(".sp-mask-loading").toggleClass("show",!1))}))}},me.prototype.initEvent=function(){var t=this;jt(this.el).find(".sp-mask-error")[0].addEventListener("click",(function(e){t._checkImage(t.slideUrl)}))};var ye=null;function ge(){var t=this;this.delay=ue,this.tasks=[],null===ye?Ee("https://"+ae.LIVE_SERVICE+"/stream/wx/delay").then((function(e){t.delay=1e3*e.delay,ye=t.delay,oe.debug("获取延迟信息，当前直播延迟",t.delay)})).catch((function(t){})):this.delay=ye}ge.prototype.setTaskPopCallback=function(t){this.popTaskCallback=t},ge.prototype.addTask=function(t){var e=Object.assign({},t,{recvTime:(new Date).getTime()});this.tasks.push(e),this.tasks.sort((function(t,e){return t.params.seq-e.params.seq}))},ge.prototype.setDelay=function(t){this.delay=t},ge.prototype.start=function(){var t=this;clearTimeout(this.handler),this.handler=setTimeout((function(){return t.run()}),500)},ge.prototype.stop=function(){clearTimeout(this.handler)},ge.prototype.run=function(){if(!this.tasks||this.tasks.length<=0)this.start();else{for(var t=(new Date).getTime(),e=[];this.tasks.length>0&&this.tasks[0].recvTime+this.delay<=t;)e.push(this.tasks.shift(0));e.length>0&&this.popTaskCallback(e),this.start()}};function Se(t){var e=t.el,n=t.report;this.el=$t(e),this.report=n,this.baseSketchpad=null,this.taskSchedule=null}Se.prototype.mount=function(){var t=this;this.baseSketchpad=new me({el:this.el,report:this.report}),this.baseSketchpad.mount(),this.taskSchedule=new ge,this.taskSchedule.setTaskPopCallback((function(){return t._onTaskPopAction.apply(t,arguments)})),this.taskSchedule.start()},Se.prototype.unmount=function(){this.baseSketchpad&&(this.baseSketchpad.unmount(),this.baseSketchpad=null),this.taskSchedule&&(this.taskSchedule.stop(),this.taskSchedule=null),jt(this.el).empty()},Se.prototype.resize=function(){this.baseSketchpad.resize()},Se.prototype.switchPageImmediate=function(t){this.baseSketchpad.switch(t),this.baseSketchpad.paint()},Se.prototype.addTrack=function(t){this.taskSchedule.addTask({action:"ADD_SHAPE_ACTION",params:t})},Se.prototype.removeTrack=function(t){this.taskSchedule.addTask({action:"REMOVE_SHAPE_ACTION",params:t})},Se.prototype.switchPage=function(t){this.taskSchedule.addTask({action:"SWITCH_PAGE_ACTION",params:t})},Se.prototype.pageScroll=function(t){this.taskSchedule.addTask({action:"SCROLL_PAGE_ACTION",params:t})},Se.prototype._onTaskPopAction=function(t){if(t&&0!==t.length){for(;t&&t.length>0;){var e=t.shift(0),n=e.action,i=e.params;switch(n){case"ADD_SHAPE_ACTION":this.baseSketchpad.addTrack(i);break;case"REMOVE_SHAPE_ACTION":this.baseSketchpad.removeTrack(i);break;case"SWITCH_PAGE_ACTION":this.baseSketchpad.switch(i);break;case"SCROLL_PAGE_ACTION":this.baseSketchpad.scroll(i)}}this.baseSketchpad.paint()}},Se.prototype.updatePlayingStatus=function(t){this.baseSketchpad.updatePlayingStatus(t)},Se.prototype.onClickPlay=function(t){this.baseSketchpad.onClickPlay(t)};function Te(t){var e=t.el;this.el=$t(e),this.video=null,this.isLoading=!1,this.playerStatus="pause",this.url="",this.eventEmitter=null,this.cameraType="live_camera"}function ke(t){var e=t.liveData,n=t.eventEmitter;this.eventEmitter=n,this.liveData=e,this.socketTask=null,this._heartbeatTimer=null,this.needReconnect=!0,this.countOfConnect=0}Te.prototype.mount=function(){this.eventEmitter=new n,jt(this.el).empty().append('<div class="sl-camera-container">\n    <video preload="none" autoplay="autoplay" class="sl-camera" webkit-playsinline="true" playsinline="" x5-playsinline="" >\n    </video>\n    <div class="sl-camera-mask play-loading">\n        <div class="sl-camera-mask-icon"></div>\n        <div class="sl-camera-mask-text">加载中...</div>\n    </div>\n    <div class="sl-camera-mask play-btn">\n        <div class="sl-camera-mask-icon"></div>\n        <div class="sl-camera-mask-text">播放</div>\n    </div>\n    <div class="sl-camera-mask play-error">\n        <div class="sl-camera-mask-icon"></div>\n        <div class="sl-camera-mask-text">重试</div>\n    </div>\n</div>'),this.video=jt(this.el).find(".sl-camera")[0],this._updatePlayerStatus("pause"),this._addEventListeners()},Te.prototype.unmount=function(){jt(this.el).empty(),this.video=null,this.eventEmitter.removeAllListeners(),this.eventEmitter=null},Te.prototype.pause=function(){this.video.pause()},Te.prototype.stop=function(){this.video.pause(),this.video.src=""},Te.prototype.continue=function(){var t=this,e=this.video.play();this._updatePlayerStatus("playing"),e&&e.catch&&e.catch((function(e){t._updatePlayerStatus("pause"),oe.warn("播放失败，可能是您的浏览器限制了自动播放功能，请手动点击播放",e)}))},Te.prototype.load=function(){if(this._updatePlayerStatus("pause"),this.url)return this._tryLoad()},Te.prototype._tryLoad=function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;return oe.info("开始LOAD视频资源, 第"+e+"次尝试",this.url),this._loadOnce().then((function(){})).catch((function(n){if(e>=3)throw t._updatePlayerStatus("error"),t.eventEmitter.emit("error",n),new Error(n);return Jt(2e3).then((function(){return t._tryLoad(e+1)}))}))},Te.prototype.requestFullScreen=function(){var t=this.video;t.webkitEnterFullScreen?t.webkitEnterFullScreen():t.requestFullscreen?t.requestFullscreen():t.mozRequestFullScreen?t.mozRequestFullScreen():t.webkitRequestFullScreen&&t.webkitRequestFullScreen()},Te.prototype.setSource=function(t){this.url=t},Te.prototype.on=function(t,e){this.eventEmitter.on(t,e)},Te.prototype._updateLoadingStatus=function(t){this.isLoading=t,jt(this.el).find(".sl-camera-container").toggleClass("loading",t)},Te.prototype._updatePlayerStatus=function(t){this.playerStatus=t,jt(this.el).find(".sl-camera-container").removeClass("pause playing error").addClass(t),this.eventEmitter.emit("status_change",{status:t})},Te.prototype._loadOnce=function(){var t=this;this.video.src=this.url;var e=new Promise((function(e,n){var i=setTimeout((function(){n("LOAD_TIMEOUT"),oe.info("LOAD视频资源超时",t.url)}),5e3);t.video.addEventListener("error",(function(e){clearTimeout(i),n("LOAD_ERROR(CODE="+e.target.error.code+")"),oe.info("LOAD视频资源错误",t.url,e.target.error)}),{once:!0}),t.video.addEventListener("canplay",(function(n){clearTimeout(i),e(),oe.info("Load视频资源成功"),t.continue()}),{once:!0})}));return this.video.load(),this.continue(),e},Te.prototype._addEventListeners=function(){var t=this;this.video.addEventListener("waiting",(function(e){t._updateLoadingStatus(!0),t.video.addEventListener("timeupdate",(function(e){t._updateLoadingStatus(!1)}),{once:!0})})),this.video.addEventListener("seeking",(function(e){t._updateLoadingStatus(!0)})),this.video.addEventListener("playing",(function(e){t._updateLoadingStatus(!1)})),this.video.addEventListener("play",(function(e){t._updateLoadingStatus(!1)})),this.video.addEventListener("seeked",(function(e){t._updateLoadingStatus(!1)})),this.video.addEventListener("playing",(function(e){t._updatePlayerStatus("playing")})),this.video.addEventListener("pause",(function(e){t._updatePlayerStatus("pause")})),jt(this.el).find(".play-btn")[0].addEventListener("click",(function(e){t.load()})),jt(this.el).find(".play-error")[0].addEventListener("click",(function(e){t.load()}))},ke.prototype.connect=function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.socketTask&&this.socketTask.close(),e?this.countOfConnect+=1:this.countOfConnect=1,oe.debug("正在第"+this.countOfConnect+"次连接直播服务..."),this.socketTask=new WebSocket("wss://"+ae.LIVE_SERVICE+"/gate"),this.socketTask.onmessage=function(){return t.onWSMessage.apply(t,arguments)},this.socketTask.onopen=function(){return t.onWSOpen.apply(t,arguments)},this.socketTask.onclose=function(){return t.onWSClose.apply(t,arguments)},this.socketTask.onerror=function(t){oe.error("直播websocket连接遇到问题",t)}},ke.prototype.onWSClose=function(){var t=this;oe.debug("直播服务连接已经断开"),this.stopHeartbeat(),setTimeout((function(){t.needReconnect&&t.countOfConnect<=8&&t.connect(!0)}),2e3)},ke.prototype.onWSOpen=function(){this.sendLogin()},ke.prototype.onWSMessage=function(t){var e=t.data,n=(e=JSON.parse(e)).eType,i=JSON.parse(e.bytes);oe.debug("直播服务收到消息",n,i),this.emit(n,i);var o=i.iCode;switch(n){case Yt.SMT_LOGIN_REPLY:0===o?(this.startHeartbeat(),this.needReconnect=!0):this.closeWS();break;case Yt.SMT_ERROR:this.error=i,this.needReconnect=2===i.operation;break;case Yt.SMT_END_LIVE:this.needReconnect=!1}},ke.prototype.closeWS=function(){this.needReconnect=!1,this.socketTask&&this.socketTask.close()},ke.prototype.dispose=function(){this.closeWS()},ke.prototype.startHeartbeat=function(){var t=this;this.stopHeartbeat(),this.sendHeartbeat(),this._heartbeatTimer=setInterval((function(){t.sendHeartbeat()}),28e3)},ke.prototype.stopHeartbeat=function(){clearInterval(this._heartbeatTimer)},ke.prototype.wsSend=function(t,e){if(this.socketTask){var n=function(t,e){return JSON.stringify({eType:t,bytes:JSON.stringify(e)})}(t,e);oe.debug("直播服务发送消息",t,e),this.socketTask.send(n)}else oe.error("直播服务发送消息失败，websocket连接还没有建立")},ke.prototype.sendLogin=function(){this.wsSend(23,Object.assign({},this.liveData,{terminalType:5}))},ke.prototype.sendHeartbeat=function(){this.wsSend(Yt.CMT_HEARTBEAT,{lTimestamp:(new Date).getTime()})},ke.prototype.emit=function(t,e){this.eventEmitter.emit("live_ws:"+t,e)};var Oe=80,Ie=4,Le=1,we=23,be=25,Ce=26,Re={SEND_LOGIN_REPLY:2,SEND_MESSAGE_REPLY:4,SEND_HEARTBEAT_REPLY:1,MESSAGE_RECV:5,USER_NOTIFICATION:10,SPEAKING_CHANGED:8,ROOM_DISMISS:11,USER_KICKED_FOR_NEW_LOGIN:9,USER_KICKED_BY_TEACHER:19,BULK_EXIT_NOTIFICATION:12,USER_FORBIDDEN_STATUS:14,QA_MESSAGE:17,ROOM_ANNOUNCEMENT_UPDATE:21,RECEIVE_PRIVATE_MESSAGE:24,SEND_PRIVATE_MESSAGE_REPLY:23,RECEIVE_PRIVATE_LIST:25,RECEIVE_PRIVATE_HISTORY:26};function Ae(t){var e=t.liveData,n=t.eventEmitter;this.eventEmitter=n,this.liveData=e,this.socketTask=null,this.countOfConnect=0,this.needReconnect=!0,this._heartbeatTimer=null}Ae.prototype.connect=function(t){var e=this;this.socketTask&&this.socketTask.close(),t?this.countOfConnect+=1:this.countOfConnect=1,oe.debug("正在第"+this.countOfConnect+"次连接聊天服务..."),this.socketTask=new WebSocket("wss://"+ae.IM_SERVICE),this.socketTask.onmessage=function(){return e.onWSMessage.apply(e,arguments)},this.socketTask.onopen=function(){return e.onWSOpen.apply(e,arguments)},this.socketTask.onclose=function(){return e.onWSClose.apply(e,arguments)},this.socketTask.onerror=function(t){oe.error("聊天websocket连接遇到问题",t)}},Ae.prototype.onWSMessage=function(t){var e=JSON.parse(t.data),n=e.cmd,i=e.data;oe.debug("聊天服务收到消息",n,e),this.emit(n,e),n===Re.SEND_LOGIN_REPLY?(this.needReconnect=!0,0===e.result?this.startHeartbeat():8!==e.result&&3!==e.result&&2!==e.result||this.closeWS()):(n===Re.USER_KICKED_FOR_NEW_LOGIN||n===Re.USER_KICKED_BY_TEACHER&&1===i.action||n===Re.ROOM_DISMISS)&&this.closeWS()},Ae.prototype.onWSOpen=function(){this.sendLogin()},Ae.prototype.onWSClose=function(){var t=this;oe.debug("聊天服务连接已经断开"),this.stopHeartbeat(),setTimeout((function(){t.needReconnect&&t.countOfConnect<=8&&t.connect(!0)}),2e3)},Ae.prototype.sendData=function(t,e,n){if(this.socketTask){var i=JSON.stringify({cmd:t,data:e,echo:n});oe.debug("聊天服务发送消息",t,{cmd:t,data:e,echo:n}),this.socketTask.send(i)}else oe.error("聊天服务发送消息失败，websocket连接还没有建立")},Ae.prototype.sendMessage=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return this._sendDataAndWaitResponse(Re.SEND_MESSAGE_REPLY,Ie,{msgData:t.toString(),msgType:e})},Ae.prototype.sendPrivateMessage=function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;return this._sendDataAndWaitResponse(Re.SEND_PRIVATE_MESSAGE_REPLY,we,{peerToken:t,msgData:e,msgType:n})},Ae.prototype.fetchPrivateList=function(){return this._sendDataAndWaitResponse(Re.RECEIVE_PRIVATE_LIST,be,{})},Ae.prototype.fetchPrivateHistory=function(t,e){return this._sendDataAndWaitResponse(Re.RECEIVE_PRIVATE_HISTORY,Ce,{peerToken:t,msgId:e})},Ae.prototype.sendLogin=function(){this.sendData(Oe,Object.assign({},this.liveData,{terminalType:5}))},Ae.prototype.sendHeartbeat=function(){this.sendData(Le,{})},Ae.prototype.startHeartbeat=function(){var t=this;this.stopHeartbeat(),this.sendHeartbeat(),this._heartbeatTimer=setInterval((function(){t.sendHeartbeat()}),2e4)},Ae.prototype.stopHeartbeat=function(){clearInterval(this._heartbeatTimer)},Ae.prototype.closeWS=function(){this.needReconnect=!1,this.socketTask&&this.socketTask.close()},Ae.prototype.dispose=function(){this.closeWS()},Ae.prototype.emit=function(t,e){this.eventEmitter.emit("chat_ws:"+t,e)},Ae.prototype._sendDataAndWaitResponse=function(t,e,n){var i=this;return new Promise((function(o,r){var s,a,c=(s=new Date,a=""+s.getSeconds()+s.getMilliseconds()+Math.floor(100*Math.random()),parseInt(a,10)),l=null,u=function(t){t.echo===c&&(clearTimeout(l),o(t))};i.eventEmitter.once("chat_ws:"+t,u),l=setTimeout((function(){i.eventEmitter.removeListener("chat_ws:"+t,u),r()}),5e3),i.sendData(e,n,c)}))};var Pe=Gt;function De(t){var e=null,n=t.iId;if(t.iType===Pe.TT_SOLID_LINE||t.iType===Pe.TT_DASH_LINE||t.iType===Pe.TT_PATH){var i=t.points||[],o=[],r=t.iType===Pe.TT_DASH_LINE;i.forEach((function(t){o.push(t.x),o.push(t.y)})),e={id:n,type:"path",dash:r,points:o,color:Ne(t.iColor),width:t.penWidth}}else if(t.iType===Pe.TT_ARROW_LINE){var s=t.points||[],a=[];s.forEach((function(t){a.push(t.x),a.push(t.y)})),e={id:n,type:"arrow",points:a,color:Ne(t.iColor),width:t.penWidth}}else if(t.iType===Pe.TT_RECT){e={id:n,type:"rect",points:[t.points[0].x,t.points[0].y,t.points[1].x,t.points[1].y],color:Ne(t.iColor),width:t.penWidth}}else if(t.iType===Pe.TT_ELLIPSE){e={id:n,type:"ellipse",points:[t.points[0].x,t.points[0].y,t.points[1].x,t.points[1].y],color:Ne(t.iColor),width:t.penWidth}}else if(t.iType===Pe.TT_TEXT){e={id:n,type:"text",points:[t.points[0].x,t.points[0].y,t.points[1].x,t.points[1].y],text:t.sText,fontSize:t.fontSize,color:Ne(t.iColor)}}return e?(e.courseId=t.iCoursewareId,e.pageId=t.iPageId,e.sequence=t.lSequence,e.width&&(e.width*=ce),e.fontSize&&(e.fontSize*=le)):oe.warn("读取到没有支持的轨迹",t),e}function Me(t){var e=t&&t.traces||{},n=[];return Object.keys(e).forEach((function(t){var i=De(e[t]);i&&n.push(i)})),n}function Ne(t){if(!t)return[255,255,255,0];var e=t.toString(16),n=((""+(e.length<8?Array.from({length:8-e.length+1}).join(0):"")+e).match(/[A-Za-z0-9]{2}/g)||[]).map((function(t){return parseInt(t,16)})),i=n[0];return[n[1],n[2],n[3],i]}function xe(t){return Ne(t.iColor)}function He(t){var e=t.sUrl?"https:"+t.sUrl:"",n=t.iWidth/t.iHeight;return Xt(e),{imageSrc:e,imageRatio:n,imageWidth:t.iWidth,imageHeight:t.iHeight}}function We(t){null!==t.iPageId&&void 0!==t.iPageId||oe.warn("从服务端读取到的pageid为空",t.iPageId),null!==t.iCoursewareId&&void 0!==t.iCoursewareId||oe.warn("从服务端读取到的coursewareid为空",t.iCoursewareId);var e=function(t){var e=t.iScrollPosition,n=t.iTabulaHeight;return{boardRatio:t.iTabulaWidth/n,yScroll:e}}(t),n=He(t);return{screenRatio:e.boardRatio,scroll:e.yScroll,slideRatio:n.imageRatio,slide:n.imageSrc,slideColor:xe(t),shapes:Me(t),pageId:t.iPageId,coursewareId:t.iCoursewareId}}var Ve=Yt;function Fe(t){var e=t.sketchpad,n=t.camera;e&&(!function(t){var e=t.sketchpad;t.on("live_ws:"+Ve.SMT_LOGIN_REPLY,(function(t){if(0===t.iCode){var n=t.roomInfo.page;e.switchPageImmediate(We(n))}})),t.on("live_ws:"+Ve.SMT_PAGE_CHANGE_NOTIFY,(function(t){e.switchPage(Object.assign({},We(t),{seq:t.lSequence}))})),t.on("live_ws:"+Ve.SMT_SCROLL_POSITION,(function(t){var n=t.iCoursewareId,i=t.iPageId,o=t.iScrollPosition,r=t.lSequence;e.pageScroll({coursewareId:n,pageId:i,scroll:o,seq:r})})),t.on("live_ws:"+Ve.SMT_ADD_TRACE,(function(t){var n=t.iCoursewareId,i=t.iPageId,o=t.lSequence;e.addTrack({coursewareId:n,pageId:i,shape:De(t),seq:o})})),t.on("live_ws:"+Ve.SMT_ERASE_TRACE,(function(t){var n=t.iCoursewareId,i=t.iPageId,o=t.traceIds,r=void 0===o?[]:o,s=t.lSequence;e.removeTrack({coursewareId:n,pageId:i,shapeIds:r,seq:s})}))}(t),e.onClickPlay((function(){n&&n.load()})),n?n.on("status_change",(function(t){var n=t.status;e.updatePlayingStatus("playing"===n)})):e.updatePlayingStatus(!0))}var qe={LIVE_CAMERA_TYPE_CHANGE:"camera:type_change",LIVE_ROOM_INFO:"room:info",LIVE_ROOM_STATUS_UPDATE:"room:status_update",LIVE_ROOM_KICKED:"room:kicked",LIVE_ROOM_KICKED_FOR_NEW_LOGIN:"room:kicked_for_new_login",LIVE_ROOM_PROMOTE:"room:promote",LIVE_ROOM_CHAT_CONNECTED:"room:chat_connected",LIVE_ROOM_ANNOUNCE_UPDATE:"room:announce_update",LIVE_ROOM_SPEAKING_UPDATE:"room:speaking_status_update",LIVE_ROOM_RECV_MSG:"room:recv_msg",LIVE_ROOM_RECV_PRIVATE_MSG:"room:recv_private_msg",REPLAY_ROOM_PROMOTE:"room:promote",REPLAY_ROOM_RAFFLE_START:"room:raffle_start",REPLAY_ROOM_RAFFLE_END:"room:raffle_end",REPLAY_ROOM_RECV_MSG:"room:recv_msg",REPLAY_CAMERA_SEEKED:"camera:seeked",REPLAY_ROOM_INFO:"room:info",REPLAY_CAMERA_TYPE_CHANGE:"camera:type_change",REPLAY_CAMERA_TIMEUPDATE:"camera:timeupdate",REPLAY_CAMERA_ENDED:"camera:ended",FAKE_ROOM_INFO:"room:info",FAKE_ROOM_STATUS_UPDATE:"room:status_update",FAKE_CAMERA_TYPE_CHANGE:"camera:type_change",FAKE_CAMERA_TIMEUPDATE:"camera:timeupdate",FAKE_CAMERA_ENDED:"camera:ended",FAKE_ROOM_KICKED:"room:kicked",FAKE_ROOM_KICKED_FOR_NEW_LOGIN:"room:kicked_for_new_login",FAKE_ROOM_CHAT_CONNECTED:"room:chat_connected",FAKE_ROOM_ANNOUNCE_UPDATE:"room:announce_update",FAKE_ROOM_SPEAKING_UPDATE:"room:speaking_status_update",FAKE_ROOM_RECV_MSG:"room:recv_msg",FAKE_ROOM_RECV_PRIVATE_MSG:"room:recv_private_msg",VIDEO_ROOM_INFO:"room:info",VIDEO_CAMERA_SEEKED:"camera:seeked",VIDEO_CAMERA_TIMEUPDATE:"camera:timeupdate",VIDEO_CAMERA_ENDED:"camera:ended"},je=Yt,Ge=Ut;function Ue(t,e){var n=e.camera,i=function(t){var e=t.filter((function(t){return t.eStreamProtocol===Ge.HLS_PROTOCOL}));return e&&e.length>0?e[0].sHttpsUrl:""}(t),o=function(t){var e=t.filter((function(t){return t.eStreamProtocol===Ge.HLS_PROTOCOL}));return e&&e.length>0?e[0].eUrlType:1}(t);e._cameraType!==o&&(e.emit(qe.LIVE_CAMERA_TYPE_CHANGE,{cameraType:o}),e._cameraType=o),i&&(n.setSource(i),n.load())}var Ke,Be=Yt,Ye=Kt,ze=Bt,$e="SMT_BEGIN_RAFFLE_INFO",Je="SMT_RAFFLE_RESULT";function Xe(t){var e,n,i;n=(e=t).report,i=Date.now(),e.once("live_ws:"+Be.SMT_LOGIN_REPLY,(function(t){if(0===t.iCode){var e=t.iUserId,o=t.roomInfo.iRoomId;n.setRoomId(o),n.setUserId(e),n.setBizType(0),n.login({loadTime:Date.now()-i})}})),t.on("live_ws:"+Be.SMT_LOGIN_REPLY,(function(e){if(0===e.iCode){var n=e.roomInfo,i=e.iUserId;t.iUserId=i,t.liveWS.countOfConnect<=1&&t.emit(qe.LIVE_ROOM_INFO,{name:n.sName,teacher:n.sTeacher}),Qe(t,n.iStatus)}})),t.on("live_ws:"+Be.SMT_PAUSE_LIVE_NOTIFY,(function(e){Qe(t,Ye.PAUSE)})),t.on("live_ws:"+Be.SMT_CONTINUE_LIVE_NOTIFY,(function(e){Qe(t,Ye.LIVE)})),t.on("live_ws:"+Be.SMT_BEGIN_LIVE,(function(e){Qe(t,Ye.LIVE)})),t.on("live_ws:"+Be.SMT_END_LIVE,(function(e){Qe(t,Ye.END)})),t.on("live_ws:"+Be.SMT_ERROR,(function(e){var n=e.iCode;n===ze.EC_KICK_BY_ADMIN&&(t.camera&&t.camera.stop(),t.emit(qe.LIVE_ROOM_KICKED,{})),n===ze.EC_ROOM_REPEAT_LOGIN&&(t.camera&&t.camera.stop(),t.emit(qe.LIVE_ROOM_KICKED_FOR_NEW_LOGIN,{}))})),t.on("live_ws:"+Be.SMT_LOGIN_REPLY,(function(e){e.iCode===ze.EC_KICK_BY_ADMIN&&(t.camera&&t.camera.stop(),t.emit(qe.LIVE_ROOM_KICKED,{}))})),t.taskSchedule=new ge,t.taskSchedule.setTaskPopCallback((function(e){e&&e.forEach((function(e){t.emit(qe.LIVE_ROOM_PROMOTE,{list:e.list,operate:e.operate,seq:e.seq})}))})),t.taskSchedule.start(),t.on("live_ws:"+Be.SMT_PROMOTE,(function(e){1===e.doRightNow?t.emit(qe.LIVE_ROOM_PROMOTE,{list:e.data,operate:e.operate,seq:e.lSequence}):t.taskSchedule.addTask({seq:e.lSequence,list:e.data,operate:e.operate})})),t.raffleTaskSchedule=new ge,t.raffleTaskSchedule.setTaskPopCallback((function(e){if(e&&0!==e.length)for(;e&&e.length>0;){var n=e.shift(0),i=n.action,o=n.params;switch(i){case $e:t.emit(qe.REPLAY_ROOM_RAFFLE_START,o);break;case Je:t.emit(qe.REPLAY_ROOM_RAFFLE_END,o)}}})),t.raffleTaskSchedule.start(),t.on("live_ws:"+Be.SMT_BEGIN_RAFFLE_INFO,(function(e){t.raffleTaskSchedule.addTask({action:$e,params:{seq:e.lSequence,name:e.name}})})),t.on("live_ws:"+Be.SMT_RAFFLE_RESULT,(function(e){var n=e.winners,i=(void 0===n?[]:n).includes(t.iUserId)?1:0;t.raffleTaskSchedule.addTask({action:Je,params:{seq:e.lSequence,name:e.name,isWinner:i}})}))}function Qe(t,e){t._roomStatus=e,t.emit(qe.LIVE_ROOM_STATUS_UPDATE,{status:e}),te(t,e),t.report.setRoomStatus(e)}function Ze(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}var tn=Kt,en="https://"+ae.REPORT_SERVICE+"/stream/report",nn=(Ze(Ke={},1,"视频卡顿"),Ze(Ke,2,"图片卡顿"),Ze(Ke,3,"视频错误"),Ze(Ke,7,"图片错误"),Ze(Ke,9,"视频加载"),Ze(Ke,8,"用户登录"),Ke);function on(){this.params={appType:5,appVersion:"2.2.1"},this.roomStatus=null}function rn(t,e){if(t){var n=t.video,i=null,o=null,r=!1;n.addEventListener("loadedmetadata",(function(t){i=Date.now()})),t.on("error",(function(t){e.streamError({uri:n.src})})),n.addEventListener("loadedmetadata",(function(t){i=Date.now();var o=function(t){if(t.target.currentTime>0){r=!0,n.removeEventListener("timeupdate",o);var s=Date.now()-i;e.streamLoad({uri:n.src,loadTime:s})}};n.addEventListener("timeupdate",o)}),{once:!0}),n.addEventListener("pause",(function(t){o=null})),n.addEventListener("waiting",(function(t){if(r){o=Date.now();var i=function(t){if(t.target.currentTime>0&&(n.removeEventListener("timeupdate",i),o)){var r=Date.now()-o;o=null,r>pe&&e.streamStuck({uri:n.src,loadTime:r})}};n.addEventListener("timeupdate",i)}}))}else oe.error("camera对象为空， 无法上报视频相关卡顿数据")}function sn(){var t=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).liveData;this.liveData=t,this.eventEmitter=new n,this.liveWS=null,this.chatWS=null,this.sketchpad=null,this.camera=null,this._cameraType=null,this._roomStatus=null,this.report=new on,this.taskSchedule=null}on.prototype.setRoomId=function(t){this.params.rid=t},on.prototype.setUserId=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";this.params.uid=t.toString()},on.prototype.setRoomStatus=function(t){this.roomStatus=t},on.prototype.setBizType=function(t){this.params.biz=t},on.prototype.send=function(t){null!==this.params.rid&&void 0!==this.params.rid||oe.error("roomId is required!"),null!==this.params.uid&&void 0!==this.params.uid||oe.error("userId is required!"),Ee(en,JSON.stringify(t)),oe.debug("打点服务",nn[t.msgType],t)},on.prototype.streamStuck=function(t){var e=t.uri,n=t.loadTime,i=Object.assign({msgType:1,uri:e,loadTime:n,player_type:"video"},this.params);this.send(i)},on.prototype.streamLoad=function(t){var e=t.uri,n=t.loadTime,i=Object.assign({msgType:9,uri:e,loadTime:n,player_type:"video"},this.params);this.send(i)},on.prototype.streamError=function(t){var e=t.uri,n=t.loadTime,i=t.failMsg,o=void 0===i?"":i,r=Object.assign({msgType:3,uri:e,loadTime:n,failMsg:o,player_type:"video"},this.params);this.send(r)},on.prototype.imageStuck=function(t){var e=t.uri,n=t.loadTime,i=t.courseId,o=t.pageId;if(this.roomStatus!==tn.READY||this.roomStatus!==tn.END){var r=Object.assign({msgType:2,uri:e,loadTime:n,courseId:i,pageId:o},this.params);this.send(r)}else oe.debug("当前出于课程未处于直播状态，不上报数据")},on.prototype.imageError=function(t){var e=t.uri,n=t.loadTime,i=t.courseId,o=t.pageId;if(this.roomStatus!==tn.READY||this.roomStatus!==tn.END){var r=Object.assign({msgType:7,uri:e,loadTime:n,courseId:i,pageId:o},this.params);this.send(r)}else oe.debug("当前出于课程未处于直播状态，不上报数据")},on.prototype.login=function(t){var e=t.loadTime,n=Object.assign({msgType:8,loadTime:e},this.params);this.send(n)},sn.prototype.dispose=function(){this.eventEmitter.removeAllListeners(),this.eventEmitter=null,this.liveWS&&(this.liveWS.dispose(),this.liveWS=null),this.sketchpad&&(this.sketchpad.unmount(),this.sketchpad=null),this.camera&&(this.camera.unmount(),this.camera=null),this.taskSchedule&&(this.taskSchedule.stop(),this.taskSchedule=null)},sn.prototype.initSketchpad=function(t){this.sketchpad=new Se(Object.assign({},t,{report:this.report})),this.sketchpad.mount()},sn.prototype.initCamera=function(t){this.camera=new Te(t),this.camera.mount(),rn(this.camera,this.report)},sn.prototype.initLiveWS=function(){this.liveWS=new ke({liveData:this.liveData,eventEmitter:this.eventEmitter}),this.liveWS.connect()},sn.prototype.initChatWS=function(){this.chatWS=new Ae({liveData:this.liveData,eventEmitter:this.eventEmitter}),this.chatWS.connect()},sn.prototype.connect=function(){var t,e,n,i;Fe(this),e=null,n=null,(i=(t=this).camera)&&(t.on("live_ws:"+je.SMT_LOGIN_REPLY,(function(e){if(0===e.iCode){var n=e.roomInfo.streamPullUrls;Ue(void 0===n?[]:n,t)}})),t.on("live_ws:"+je.SMT_CHANGE_CDN_NOTIFY,(function(i){var o=i.streamPullUrls,r=void 0===o?[]:o;clearTimeout(e),n=setTimeout((function(){Ue(r,t)}),fe)})),t.on("live_ws:"+je.SMT_END_LIVE,(function(t){clearTimeout(n),setTimeout((function(){i.pause()}),fe)})),t.on("live_ws:"+je.SMT_PAUSE_LIVE_NOTIFY,(function(t){clearTimeout(n),e=setTimeout((function(){i.pause()}),fe)}))),Xe(this),function(t){t.on("chat_ws:"+Re.SEND_LOGIN_REPLY,(function(e){if(0===e.result){var n=e.data,i=n.forbiddenStatus,o=n.roomAnnounce;t.emit(qe.LIVE_ROOM_CHAT_CONNECTED,e),t.emit(qe.LIVE_ROOM_SPEAKING_UPDATE,{speakingStatus:i}),t.emit(qe.LIVE_ROOM_ANNOUNCE_UPDATE,{announce:o})}})),t.on("chat_ws:"+Re.SPEAKING_CHANGED,(function(e){t.emit(qe.LIVE_ROOM_SPEAKING_UPDATE,{speakingStatus:e.data.status})})),t.on("chat_ws:"+Re.ROOM_ANNOUNCEMENT_UPDATE,(function(e){t.emit(qe.LIVE_ROOM_ANNOUNCE_UPDATE,{announce:e.data.announce})})),t.on("chat_ws:"+Re.MESSAGE_RECV,(function(e){t.emit(qe.LIVE_ROOM_RECV_MSG,e)})),t.on("chat_ws:"+Re.RECEIVE_PRIVATE_MESSAGE,(function(e){t.emit(qe.LIVE_ROOM_RECV_PRIVATE_MSG,e)})),t.on(qe.LIVE_ROOM_KICKED,(function(e){t.chatWS&&t.chatWS.closeWS()})),t.on(qe.LIVE_ROOM_KICKED_FOR_NEW_LOGIN,(function(e){t.chatWS&&t.chatWS.closeWS()}))}(this),this.initLiveWS(),this.initChatWS()},sn.prototype.on=function(t,e){this.eventEmitter.on(t,e,this)},sn.prototype.once=function(t,e){this.eventEmitter.once(t,e,this)},sn.prototype.emit=function(){var t;(t=this.eventEmitter).emit.apply(t,arguments)};var an="https://"+ae.REPLAY_SERVICE+"/video";var cn={login:function(t){var e=Object.assign({},t,{terminalType:5});return Ee(an+"/thirdLogin",JSON.stringify(e)).then((function(t){return t.err?t:function(t){if(!t.videoPlayUrls)return t;var e=t.videoPlayUrls.filter((function(t){return"mp4"===t.sFormat}))[0],n=(e=void 0===e?{}:e).sHttpsUrl,i=e.sequenceInfos,o=void 0===i?[]:i,r=t.videoPlayUrls.filter((function(t){return t.sharedPlaybackUrlInfos&&t.sharedPlaybackUrlInfos.find((function(t){return"mp4"===t.sFormat}))}))[0],s=(r=void 0===r?{}:r).sharedPlaybackUrlInfos,a=void 0===s?[]:s,c=[].concat(o.map((function(t){return{originStartDuration:t.iStart,startDuration:t.iStart,endDuration:t.iStart+t.iDuration,duration:t.iDuration,initSeq:t.lSequence,url:n,type:1}})),a.map((function(t){return{originStartDuration:0,startDuration:t.iStartTime,endDuration:t.iStartTime+t.iDuration,duration:t.iDuration,initSeq:t.lSequence,type:t.eUrlType,url:t.sHttpsUrl}}))).sort((function(t,e){return t.initSeq-e.initSeq}));if(c.forEach((function(t,e,n){if(0!==e){var i=n[e-1].endDuration;t.startDuration=i,t.endDuration=i+t.duration}})),c.length>0)return Object.assign({},t,{videoList:c});return t}(t)}))},heartbeat:function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;return Ee(an+"/heartbeat",JSON.stringify({token:{roomId:e,token:t,pausePlay:n}}))},getIncrShapes:function(t,e,n,i){return Ee(an+"/getincrmsg",JSON.stringify({lSequence:Math.floor(n),iInterval:i,token:{roomId:e,token:t}}))},getInitShapes:function(t,e,n){return Ee(an+"/getpage",JSON.stringify({lSequence:Math.floor(n),token:{roomId:e,token:t}}))},lookupSequence:function(t,e){var n=null;return e.forEach((function(e){var i=e.startDuration,o=e.initSeq;t>=i&&(n=1e3*(t-i)+o)})),n||oe.error("查询sequence出错，找不到对应的sequence","currentTime = ",t,e),n},lookupDuration:function(t,e){for(var n=null,i=e.length-1;i>=0;i--){var o=e[i],r=o.startDuration,s=o.initSeq;if(t>s){n=Math.floor(r+(t-s)/1e3);break}}return n}},ln="https://"+ae.IM_SERVICE+"/h/get_live_message_history?live_id=:liveId&ts_lower_bound=:start&ts_upper_bound=:end";var un={getChatHistory:function(t,e,n){return _e(ln.replace(/:liveId/,t).replace(/:start/,Math.floor(e/1e3)).replace(/:end/,Math.floor(n/1e3)))}};function hn(t){var e=t.liveData,n=t.eventEmitter,i=t.clipParams;this.clipParams=i,this.liveData=e,this.eventEmitter=n,this.heartbeatTimer=null,this.token=null,this.roomId=null,this.pausePlay=null,this.videoList=[]}hn.prototype.connect=function(){var t,e=this;this.stopHeartbeat(),this.clipParams&&(t=Object.assign({},this.clipParams,{extraJson:JSON.stringify(this.clipParams.extraJson)}));var n=Object.assign({},this.liveData,{},t);cn.login(n).then((function(t){t.err||(e.token=t.token,e.roomId=t.roomInfo.iRoomId,e.videoList=t.videoList,e.startHeartbeat(),e.eventEmitter.emit("replay_http:login_reply",t),oe.debug("点播登录回复",t))}))},hn.prototype.startHeartbeat=function(){var t=this;clearInterval(this.heartbeatTimer),cn.heartbeat(this.token,this.roomId),this.heartbeatTimer=setInterval((function(){null!==t.pausePlay&&void 0!==t.pausePlay||oe.warn("心跳缺失pausePlay字段"),cn.heartbeat(t.token,t.roomId,t.pausePlay)}),3e4)},hn.prototype.stopHeartbeat=function(){clearInterval(this.heartbeatTimer)},hn.prototype.dispose=function(){this.stopHeartbeat()},hn.prototype.getInitShapes=function(t){return cn.getInitShapes(this.token,this.roomId,t)},hn.prototype.getInitShapesByCurrentTime=function(t){var e=cn.lookupSequence(t,this.videoList);return e?this.getInitShapes(e):Promise.reject("找不到对应的sequence")},hn.prototype.lookupSequence=function(t){return cn.lookupSequence(t,this.videoList)},hn.prototype.getIncrShapes=function(t,e){return cn.getIncrShapes(this.token,this.roomId,t,e)},hn.prototype.getIncrShapesByCurrentTime=function(t,e){var n=cn.lookupSequence(t,this.videoList);return n?this.getIncrShapes(n,e):Promise.reject("找不到对应的sequence")},hn.prototype.getChatHistoryByCurrentTime=function(t,e){var n=cn.lookupSequence(t,this.videoList),i=cn.lookupSequence(e,this.videoList);if(n&&i)return un.getChatHistory(this.roomId,n,i)},hn.prototype.updatePlayStatus=function(t){this.pausePlay=t};function dn(t){var e=t.el,i=t.showControls,o=void 0===i||i;this.el=$t(e),this.eventEmitter=new n,this.duration=0,this.currentTime=0,this._progressDragging=!1,this._hideProgressTimer=null,this._playStatus="pause",this.showControls=o}function pn(t){var e=parseInt(t,10);e=Number.isNaN(e)?0:e;var n=Math.floor(e/60),i=e-60*n;return n<10&&(n="0"+n),i<10&&(i="0"+i),n+":"+i}dn.prototype.mount=function(){jt(this.el).append('<div class="sl-control pause">\n    <div class="sl-control-button">\n        <div class="sl-control-button-play"></div>\n        <div class="sl-control-button-pause"></div>\n    </div>\n    <div class="sl-control-progress">\n        <div class="sl-control-progress-bar"></div>\n        <div class="sl-control-progress-bar-played"></div>\n        <div class="sl-control-progress-bar-handler"></div>\n        <div class="sl-control-progress-bar-dot-handler">\n            <div class="sl-control-progress-bar-dot"></div>\n        </div>\n    </div>\n    <div class="sl-control-remaining">\n        00:00 / 00:00\n    </div>\n    <div class="sl-control-fs">全屏</div>\n</div>'),this.controlNode=jt(this.el).find(".sl-control"),this.remainingNode=jt(this.el).find(".sl-control-remaining"),this.playedProgressNode=jt(this.el).find(".sl-control-progress-bar-played"),this.dotHandlerNode=jt(this.el).find(".sl-control-progress-bar-dot-handler"),this.dotNode=jt(this.el).find(".sl-control-progress-bar-dot"),this.progressHandlerNode=jt(this.el).find(".sl-control-progress-bar-handler"),this.setVisible(this.showControls),this.render(),this.initEvent()},dn.prototype.initEvent=function(){var t=this;jt(this.el).find(".sl-control-button-pause")[0].addEventListener("click",(function(e){t.eventEmitter.emit("pause")})),jt(this.el).find(".sl-control-button-play")[0].addEventListener("click",(function(e){t.eventEmitter.emit("play")})),jt(this.el).find(".sl-control-fs")[0].addEventListener("click",(function(e){t.eventEmitter.emit("fullscreen")})),window.addEventListener("touchstart",this._onProgressSeek.bind(this)),window.addEventListener("touchmove",this._onProgressSeek.bind(this)),window.addEventListener("touchend",this._onProgressSeek.bind(this))},dn.prototype._onProgressSeek=function(t){switch(t.type){case"touchstart":t.target!==this.dotNode[0]&&t.target!==this.dotHandlerNode[0]||(this._progressDragging=!0);break;case"touchmove":if(this._progressDragging){this.hideLater();var e=this._getSeconds(t);this.currentTime=e,this.render()}break;case"touchend":if(this._progressDragging){this.hideLater(),this._progressDragging=!1;var n=this._getSeconds(t);this.eventEmitter.emit("seeked",{currentTime:n}),this.setTime(n,this.duration)}else if(t.target===this.progressHandlerNode[0]){this.hideLater();var i=this._getSeconds(t);this.eventEmitter.emit("seeked",{currentTime:i}),this.setTime(i,this.duration)}}},dn.prototype.unmount=function(){this.eventEmitter.removeAllListeners(),this.eventEmitter=null,jt(this.el).find(".sl-control").remove(),window.removeEventListener("touchstart",this._onProgressSeek),window.removeEventListener("touchmove",this._onProgressSeek),window.removeEventListener("touchend",this._onProgressSeek)},dn.prototype.setTime=function(t,e){this._progressDragging||(this.currentTime=t,this.duration=e,this.render())},dn.prototype.setStatus=function(t){this.controlNode.removeClass("playing").removeClass("pause").addClass(t),this._playStatus=t},dn.prototype.on=function(t,e){this.eventEmitter.on(t,e,this)},dn.prototype.render=function(){var t=pn(this.duration),e=pn(this.currentTime),n=(this.currentTime/this.duration*100).toFixed(1);this.remainingNode.text(e+" / "+t),this.dotHandlerNode.css("left",n+"%"),this.playedProgressNode.css("width",n+"%")},dn.prototype.setVisible=function(t){!this.showControls&&t||this.controlNode.toggleClass("hide",!t)},dn.prototype.hideLater=function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:5e3;this.setVisible(!0),clearTimeout(this._hideProgressTimer),this._hideProgressTimer=setTimeout((function(){"pause"===t._playStatus?t.hideLater():t.setVisible(!1)}),e)},dn.prototype._getSeconds=function(t){var e=t.changedTouches[0].clientX,n=this.progressHandlerNode[0].getBoundingClientRect(),i=n.left,o=n.width,r=Math.max(Math.min(e-i,o),0);return Math.floor(r*this.duration/o)};function fn(t){var e=t.el,n=t.showControls;this.el=$t(e),this.video=null,this.videoList=[],this.currentSegment=0,this.wholeDuration=0,this.wholeCurrentTime=0,this._flagRefreshed=!1,this._flagSeeked=!1,this.controls=null,this.showControls=n,this.isLoading=!1,this.playerStatus="pause",this.cameraType="replay_camera"}fn.prototype.mount=function(){this.eventEmitter=new n,jt(this.el).empty().append('<div class="sl-camera-container">\n    <video autoplay="autoplay" preload="none" class="sl-camera" webkit-playsinline="true" playsinline="" x5-playsinline="" >\n    </video>\n    <div class="sl-camera-mask play-loading">\n        <div class="sl-camera-mask-icon"></div>\n        <div class="sl-camera-mask-text">加载中...</div>\n    </div>\n    <div class="sl-camera-mask play-btn">\n        <div class="sl-camera-mask-icon"></div>\n        <div class="sl-camera-mask-text">播放</div>\n    </div>\n    <div class="sl-camera-mask play-error">\n        <div class="sl-camera-mask-icon"></div>\n        <div class="sl-camera-mask-text">重试</div>\n    </div>\n</div>'),this.video=jt(this.el).find(".sl-camera")[0],this._fixVideoPlay(),this.bindListener(),this.initControls(),this._listenPlayerStatus()},fn.prototype._updateLoadingStatus=function(t){this.isLoading=t,jt(this.el).find(".sl-camera-container").toggleClass("loading",t)},fn.prototype._updatePlayerStatus=function(t){this.playerStatus=t,jt(this.el).find(".sl-camera-container").removeClass("pause playing error").addClass(t)},fn.prototype._listenPlayerStatus=function(){var t=this;this.video.addEventListener("loadstart",(function(e){t._updateLoadingStatus(!0)})),this.video.addEventListener("waiting",(function(e){t._updateLoadingStatus(!0)})),this.video.addEventListener("seeking",(function(e){t._updateLoadingStatus(!0)})),this.video.addEventListener("play",(function(e){t._updateLoadingStatus(!1)})),this.video.addEventListener("seeked",(function(e){t._updateLoadingStatus(!1)})),this.video.addEventListener("canplay",(function(e){t._updateLoadingStatus(!1)})),this.video.addEventListener("error",(function(e){t._updateLoadingStatus(!1)})),jt(this.el).find(".play-error")[0].addEventListener("click",(function(e){t.load()})),this.video.addEventListener("error",(function(e){t._updatePlayerStatus("error"),t.eventEmitter.emit("error",e.target.error)})),jt(this.el).find(".play-btn")[0].addEventListener("click",(function(e){t.continue()})),this.video.addEventListener("play",(function(e){t._updatePlayerStatus("playing")})),this.video.addEventListener("pause",(function(e){t._updatePlayerStatus("pause")}))},fn.prototype._fixVideoPlay=function(){var t=this,e=this.video.play;this.video.play=function(){var n=e.call(t.video);n&&n.catch((function(e){setTimeout((function(){t.video.paused&&t.eventEmitter.emit("pause")}),1e3)}))}},fn.prototype.initControls=function(){var t=this;this.controls=new dn({el:jt(this.el).find(".sl-camera-container")[0],showControls:this.showControls}),this.controls.mount(),this.controls.hideLater(),this.controls.on("play",(function(){t.continue()})),this.controls.on("pause",(function(){t.pause()})),this.controls.on("seeked",(function(e){var n=e.currentTime;t.seek(n)})),jt(this.el)[0].addEventListener("click",(function(e){t.controls.hideLater()})),this.controls.on("fullscreen",(function(){t.fullScreen()}))},fn.prototype.unmount=function(){jt(this.el).empty(),this.video=null,this.eventEmitter.removeAllListeners(),this.eventEmitter=null,this.controls.unmount()},fn.prototype.setVideoList=function(t){this.wholeDuration=t.reduce((function(t,e){return t+e.duration}),0),this.videoList=t,this.controls.setTime(0,this.wholeDuration)},fn.prototype.load=function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.loadAndSeek(0,0,t),this._flagSeeked=!0},fn.prototype.pause=function(){this.video.pause()},fn.prototype.stop=function(){this.video.pause(),this.video.src=""},fn.prototype.continue=function(){this.isEnded()?this.load(!0):this.video.play()},fn.prototype.isEnded=function(){return this.currentSegment===this.videoList.length-1&&this.video.ended},fn.prototype.switchNextSegment=function(){var t=this.currentSegment+1;if(t>=this.videoList.length)this.eventEmitter.emit("ended");else{var e=this.videoList[t].originStartDuration;this.loadAndSeek(t,e,!0)}},fn.prototype.getCurrentSegment=function(){return this.videoList[this.currentSegment]},fn.prototype.seek=function(t){var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=this.lookupSegmentByDuration(t),i=n.segmentIndex,o=n.currentTime;null==i&&oe.error("seek时间超出范围，无法完成seek操作","currentTime",t),this.loadAndSeek(i,o,e),this._flagSeeked=!0},fn.prototype.loadAndSeek=function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];oe.debug("加载新的段",e,"跳转到进度",n),this.currentSegment=e,this._flagRefreshed=!0,this.video.pause(),this.video.src=this.videoList[this.currentSegment].url,this.video.addEventListener("canplay",(function(e){if(n<=0)i&&t.video.play();else{t.video.addEventListener("seeked",(function(e){i&&t.video.play()}),{once:!0});var o=function(e){e.target.currentTime&&e.target.currentTime>0&&(Math.abs(n-e.target.currentTime>3)&&(t.video.currentTime=n),t.video.removeEventListener("timeupdate",o))};t.video.addEventListener("timeupdate",o),t.video.currentTime=n}}),{once:!0}),this.video.load()},fn.prototype._onEnded=function(t){this.switchNextSegment()},fn.prototype._onTimeupdate=function(t){if(!(t.target.currentTime<=0)){var e=this.videoList[this.currentSegment];this.wholeCurrentTime=t.target.currentTime+e.startDuration-e.originStartDuration,this.eventEmitter.emit("timeupdate",{duration:this.wholeDuration,currentTime:this.wholeCurrentTime}),this._flagRefreshed&&(this._flagRefreshed=!1,this.eventEmitter.emit("refreshed",{duration:this.wholeDuration,currentTime:this.wholeCurrentTime})),this._flagSeeked&&(this._flagSeeked=!1,this.eventEmitter.emit("seeked",{duration:this.wholeDuration,currentTime:this.wholeCurrentTime})),this.controls.setTime(this.wholeCurrentTime,this.wholeDuration),e.endDuration-this.wholeCurrentTime<1&&1===e.type&&this.switchNextSegment()}},fn.prototype.lookupSegmentByDuration=function(t){var e=-1,n=-1;return this.videoList.every((function(i,o){return!(t>=i.startDuration&&t<i.endDuration)||(e=o,n=t-i.startDuration+i.originStartDuration,!1)})),-1===e?{}:{segmentIndex:e,currentTime:n}},fn.prototype.isPaused=function(){return this.video.paused},fn.prototype.bindListener=function(){var t=this;this.video.addEventListener("timeupdate",this._onTimeupdate.bind(this)),this.video.addEventListener("ended",this._onEnded.bind(this)),this.video.addEventListener("seeked",(function(){t._flagRefreshed=!0,t._flagSeeked=!0})),this.video.addEventListener("playing",(function(e){t.controls.setStatus(t.video.paused?"pause":"playing"),t.eventEmitter.emit("playing")})),this.video.addEventListener("pause",(function(e){t._flagRefreshed||t.video.ended&&!t.isEnded()||t.video.seeking||(t.controls.setStatus(t.video.paused?"pause":"playing"),t.eventEmitter.emit("pause"))}))},fn.prototype.on=function(t,e){this.eventEmitter.on(t,e)},fn.prototype.requestFullScreen=function(){this.fullScreen()},fn.prototype.fullScreen=function(){var t=this.video;t.webkitEnterFullScreen?t.webkitEnterFullScreen():t.requestFullscreen?t.requestFullscreen():t.mozRequestFullScreen?t.mozRequestFullScreen():t.webkitRequestFullScreen&&t.webkitRequestFullScreen()};var vn=Yt;function mn(t){var e=t.el,n=t.report,i=t.showControls,o=void 0===i||i;this.el=$t(e),this.report=n,this.baseSketchpad=null,this.controls=null,this.showControls=o}mn.prototype.mount=function(){this.baseSketchpad=new me({el:this.el,report:this.report}),this.baseSketchpad.mount(),this.initControls()},mn.prototype.initControls=function(){var t=this;this.controls=new dn({el:jt(this.el).find(".sp-container")[0],showControls:this.showControls}),this.controls.mount(),this.controls.hideLater(),jt(this.el)[0].addEventListener("click",(function(e){t.controls.hideLater()}))},mn.prototype.unmount=function(){this.controls&&this.controls.dispose(),this.baseSketchpad&&(this.baseSketchpad.unmount(),this.baseSketchpad=null),jt(this.el).empty()},mn.prototype.resize=function(){this.baseSketchpad.resize()},mn.prototype.updatePlayingStatus=function(t){this.baseSketchpad.updatePlayingStatus(t)},mn.prototype.onClickPlay=function(t){this.baseSketchpad.onClickPlay(t)},mn.prototype.render=function(t){var e=this;t&&0!==t.length&&(oe.debug("点播画板渲染数据",t),t.forEach((function(t){var n=t.eType,i=t.bytes,o=i.iCoursewareId,r=i.iPageId,s=i.traceIds,a=void 0===s?[]:s,c=i.iScrollPosition;switch(n){case vn.SMT_PAGE_CHANGE_NOTIFY:e.baseSketchpad.switch(We(i));break;case vn.SMT_ADD_TRACE:e.baseSketchpad.addTrack({coursewareId:o,pageId:r,shape:De(i)});break;case vn.SMT_ERASE_TRACE:e.baseSketchpad.removeTrack({coursewareId:o,pageId:r,shapeIds:a});break;case vn.SMT_SCROLL_POSITION:e.baseSketchpad.scroll({coursewareId:o,pageId:r,scroll:c});break;default:oe.warn("收到不支持的轨迹类型eType",n,"bytes",i)}})),this.baseSketchpad.paint())};var _n=Yt;function En(t){var e,n,i;n=(e=t).report,i=Date.now(),e.once("replay_http:login_reply",(function(t){if(!t.err){var e=t.iUserId,o=t.roomInfo.iRoomId;n.setRoomId(o),n.setUserId(e),n.setBizType(1),n.login({loadTime:Date.now()-i})}}));var o=t.camera;t.on("replay_http:login_reply",(function(e){if(e.err)oe.error("点播登录遇到错误",e);else{var n=e.roomInfo;if(t.emit(qe.REPLAY_ROOM_INFO,{name:n.sName,teacher:n.sTeacher}),e.promotes){var i=e.promotes.map((function(t){return Object.assign({},t,{duration:cn.lookupDuration(t.lSequence,e.videoList)})}));t.emit(qe.REPLAY_ROOM_PROMOTE,{promotes:i})}}})),o&&o.on("refreshed",(function(){var e=o.getCurrentSegment().type;t._cameraType!==e&&(t.emit(qe.REPLAY_CAMERA_TYPE_CHANGE,{cameraType:e}),t._cameraType=e)}))}var yn=Yt;function gn(t){var e=t.replayHttp;this.replayHttp=e,this.shapeList=[],this.lastRequestInitShapesTimestamp=null,this.interval=Math.floor(he/1e3),this.startCursor=null,this.endCursor=null,this.fetchingInitShapes=!1}function Sn(t){var e=t.replayHttp;this.replayHttp=e,this.chatList=[],this.startCursor=0,this.endCursor=0,this.interval=Math.floor(de/1e3),this.lastSeekTimestamp=null}function Tn(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=t.liveData,i=t.clipParams;this.clipParams=i,this.liveData=e,this.eventEmitter=new n,this.replayHttp=null,this.camera=null,this.sketchpad=null,this.shapeStore=null,this.historyStore=null,this._cameraType=null,this.report=new on}gn.prototype.loadInitShapes=function(t){var e=this;this.startCursor=t,this.endCursor=t,this.lastRequestInitShapesTimestamp=Date.now(),this.shapeList=[],this.fetchingInitShapes=!0,this.replayHttp.getInitShapesByCurrentTime(t).then((function(n){if(n.err)oe.error("拉取轨迹快照信息失败","currentTime "+t,n.err);else{var i=n.page;e.shapeList.push({eType:yn.SMT_PAGE_CHANGE_NOTIFY,bytes:i,_initShape:!0}),oe.debug("拉取到轨迹快照信息","currentTime "+t,n,"shape list",[].concat(e.shapeList))}e.fetchingInitShapes=!1})).catch((function(n){oe.error("拉取轨迹快照信息失败","currentTime "+t,n),e.fetchingInitShapes=!1}))},gn.prototype.checkToRequestData=function(t){null===this.endCursor||this.fetchingInitShapes||this.endCursor-t<this.interval/2&&this.loadIncrShapes()},gn.prototype.take=function(t){for(var e=this.replayHttp.lookupSequence(t),n=[];this.shapeList.length>0;){if(!(e>=this.shapeList[0].bytes.lSequence))break;n.push(this.shapeList.shift())}return n},gn.prototype.loadIncrShapes=function(){var t=this,e=this.endCursor;this.endCursor+=this.interval;var n=this.lastRequestInitShapesTimestamp;this.replayHttp.getIncrShapesByCurrentTime(e,this.interval).then((function(i){i.err?oe.error("拉取增量轨迹信息失败","currentTime "+e+" interval "+t.interval,i.err):n===t.lastRequestInitShapesTimestamp&&(i&&i.sequenceMap&&Object.keys(i.sequenceMap).forEach((function(e){i.sequenceMap[e].forEach((function(e){var n=JSON.parse(e.bytes);e.eType===yn.SMT_PAGE_CHANGE_NOTIFY&&He(n),t.shapeList.push({eType:e.eType,bytes:n})}))})),oe.debug("拉取到增量轨迹信息","currentTime "+e+" interval "+t.interval,i,"shape list",[].concat(t.shapeList)))})).catch((function(n){oe.error("拉取增量轨迹信息失败","currentTime "+e+" interval "+t.interval,n)}))},Sn.prototype.seek=function(t){this.lastSeekTimestamp=Date.now(),this.chatList=[],this.startCursor=t,this.endCursor=t},Sn.prototype.checkToRequestData=function(t){this.endCursor-t<this.interval/2&&this.loadHistory()},Sn.prototype.take=function(t){for(var e=[],n=this.replayHttp.lookupSequence(t);this.chatList.length>0&&n>=this.chatList[0].seq;)e.push(this.chatList.shift());return e},Sn.prototype.loadHistory=function(){var t=this,e=this.endCursor;this.endCursor+=this.interval;var n=this.lastSeekTimestamp;this.replayHttp.getChatHistoryByCurrentTime(e,e+this.interval).then((function(i){if(n===t.lastSeekTimestamp){var o=i.message_list;o&&o.length>0&&o.forEach((function(e){t.chatList.push({seq:1e3*e.message_ts,value:e})})),oe.debug("拉取到聊天记录","currentTime "+e+" interval "+t.interval,i)}})).catch((function(n){oe.error("拉取聊天记录失败","currentTime "+e+" interval "+t.interval,n)}))},Tn.prototype.dispose=function(){this.eventEmitter.removeAllListeners(),this.eventEmitter=null,this.replayHttp&&(this.replayHttp.dispose(),this.replayHttp=null),this.camera&&(this.camera.unmount(),this.camera=null),this.sketchpad&&(this.sketchpad.unmount(),this.sketchpad=null),this.shapeStore=null},Tn.prototype.initSketchpad=function(t){this.sketchpad=new mn(Object.assign({},t,{report:this.report})),this.sketchpad.mount()},Tn.prototype.initCamera=function(t){this.camera=new fn(t),this.camera.mount(),rn(this.camera,this.report)},Tn.prototype.connect=function(){var t,e,n,i,o,r;this.replayHttp=new hn({liveData:this.liveData,clipParams:this.clipParams,eventEmitter:this.eventEmitter}),this.shapeStore=new gn({replayHttp:this.replayHttp}),this.historyStore=new Sn({replayHttp:this.replayHttp}),e=(t=this).camera,n=t.sketchpad,i=t.shapeStore,o=t.historyStore,r=t.replayHttp,t.on("replay_http:login_reply",(function(n){if(!n.err&&e){var i=n.videoList;e.setVideoList(i),e.load(),e.pause(),e.on("seeked",(function(e){t.emit(qe.REPLAY_CAMERA_SEEKED,e)})),e.on("timeupdate",(function(e){t.emit(qe.REPLAY_CAMERA_TIMEUPDATE,e)})),e.on("ended",(function(e){t.emit(qe.REPLAY_CAMERA_ENDED,e)})),e.on("playing",(function(t){var n=e.isPaused()?1:0;r.updatePlayStatus(n)})),e.on("pause",(function(t){var n=e.isPaused()?1:0;r.updatePlayStatus(n)}))}})),e&&n&&(e.on("seeked",(function(t){var e=t.currentTime;o.seek(e)})),e.on("refreshed",(function(t){var e=t.currentTime;i.loadInitShapes(e)})),e.on("timeupdate",(function(e){var r=e.currentTime;i.checkToRequestData(r),o.checkToRequestData(r);var s=i.take(r);n.render(s);var a=o.take(r);a&&a.length>0&&t.emit(qe.REPLAY_ROOM_RECV_MSG,a)})),n.controls.on("play",(function(){e.continue()})),n.controls.on("pause",(function(){e.pause()})),n.controls.on("seeked",(function(t){var n=t.currentTime;e.seek(n)})),e.on("playing",(function(){n.controls.setStatus(e.video.paused?"pause":"playing")})),e.on("pause",(function(){n.controls.setStatus(e.video.paused?"pause":"playing")})),e.on("timeupdate",(function(t){var e=t.currentTime,i=t.duration;n.controls.setTime(e,i)}))),function(t){var e=t.sketchpad,n=t.camera;e&&(t.on("replay_http:login_reply",(function(t){if(!t.err){var n=t.roomInfo.page;e.render([{eType:_n.SMT_PAGE_CHANGE_NOTIFY,bytes:n}])}})),e.onClickPlay((function(){n&&n.continue()})),n&&(n.on("playing",(function(){e.updatePlayingStatus(!0)})),n.on("pause",(function(){e.updatePlayingStatus(!1)})),e.controls.on("fullscreen",(function(){n.fullScreen()}))))}(this),En(this),this.replayHttp.connect()},Tn.prototype.on=function(t,e){this.eventEmitter.on(t,e,this)},Tn.prototype.once=function(t,e){this.eventEmitter.once(t,e,this)},Tn.prototype.emit=function(){var t;(t=this.eventEmitter).emit.apply(t,arguments)};var kn=Yt;var On=Yt,In=Kt,Ln=Bt;function wn(t,e){t._roomStatus=e,t.emit(qe.FAKE_ROOM_STATUS_UPDATE,{status:e}),te(t,e),oe.debug("当前伪直播间状态",e)}function bn(){var t=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).liveData;this.liveData=t,this.eventEmitter=new n,this.replayHttp=null,this.liveWS=null,this.chatWS=null,this.camera=null,this.sketchpad=null,this.shapeStore=null,this.historyStore=null,this._cameraType=null,this._roomStatus=null}function Cn(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=t.liveData,i=t.clipParams;this.clipParams=i,this.liveData=e,this.eventEmitter=new n,this.replayHttp=null,this.camera=null}bn.prototype.dispose=function(){this.eventEmitter.removeAllListeners(),this.eventEmitter=null,this.replayHttp&&(this.replayHttp.dispose(),this.replayHttp=null),this.liveWS&&(this.liveWS.dispose(),this.liveWS=null),this.chatWS&&(this.chatWS.dispose(),this.chatWS=null),this.camera&&(this.camera.unmount(),this.camera=null),this.sketchpad&&(this.sketchpad.unmount(),this.sketchpad=null),this.shapeStore=null},bn.prototype.initSketchpad=function(t){this.sketchpad=new mn(Object.assign({},t,{showControls:!1})),this.sketchpad.mount()},bn.prototype.initCamera=function(t){this.camera=new fn(Object.assign({},t,{showControls:!1})),this.camera.mount()},bn.prototype.initLiveWS=function(){this.liveWS=new ke({liveData:this.liveData,eventEmitter:this.eventEmitter}),this.liveWS.connect()},bn.prototype.initChatWS=function(){this.chatWS=new Ae({liveData:this.liveData,eventEmitter:this.eventEmitter}),this.chatWS.connect()},bn.prototype.connect=function(){var t,e,n;e=(t=this).camera,n=t.sketchpad,t.on("replay_http:login_reply",(function(n){if(!n.err&&!n.ended&&e){var i=n.videoList;e.setVideoList(i),e.load(),e.pause(),e.on("timeupdate",(function(e){t.emit(qe.FAKE_CAMERA_TIMEUPDATE,e)})),e.on("ended",(function(e){t.emit(qe.FAKE_CAMERA_ENDED,e)})),e.on("playing",(function(n){var i=e.isPaused()?1:0;t.replayHttp.updatePlayStatus(i)})),e.on("pause",(function(n){var i=e.isPaused()?1:0;t.replayHttp.updatePlayStatus(i)}))}})),e&&n&&(e.on("seeked",(function(e){var n=e.currentTime;t.historyStore.seek(n)})),e.on("refreshed",(function(e){var n=e.currentTime;t.shapeStore.loadInitShapes(n)})),e.on("timeupdate",(function(e){var i=e.currentTime;t.shapeStore.checkToRequestData(i),t.historyStore.checkToRequestData(i);var o=t.shapeStore.take(i);n.render(o);var r=t.historyStore.take(i);r&&r.length>0&&r.forEach((function(e){var n=e.value,i={result:0,cmd:5,data:{liveId:t.liveData.roomId,userIdentity:n.user_identity,msgData:n.message_content,msgType:n.message_type,msgTimestamp:n.message_ts,name:n.user_name,portrait:n.user_portrait,fromUserToken:n.sender_id_str,type:"elive"}};t.emit(qe.FAKE_ROOM_RECV_MSG,i)}))})),n.controls.on("play",(function(){e.continue()})),n.controls.on("pause",(function(){e.pause()})),n.controls.on("seeked",(function(t){var n=t.currentTime;e.seek(n)})),e.on("playing",(function(){n.controls.setStatus(e.video.paused?"pause":"playing")})),e.on("pause",(function(){n.controls.setStatus(e.video.paused?"pause":"playing")})),e.on("timeupdate",(function(t){var e=t.currentTime,i=t.duration;n.controls.setTime(e,i)}))),e&&e.on("refreshed",(function(){var n=e.getCurrentSegment().type;t._cameraType!==n&&(t.emit(qe.FAKE_CAMERA_TYPE_CHANGE,{cameraType:n}),t._cameraType=n)})),function(t){var e=t.sketchpad,n=t.camera;e&&(t.on("replay_http:login_reply",(function(t){if(!t.err){var n=t.roomInfo.page;e.render([{eType:kn.SMT_PAGE_CHANGE_NOTIFY,bytes:n}])}})),e.onClickPlay((function(){n&&n.continue()})),n&&(n.on("playing",(function(){e.updatePlayingStatus(!0)})),n.on("pause",(function(){e.updatePlayingStatus(!1)})),e.controls.on("fullscreen",(function(){n.fullScreen()}))))}(this),function(t){var e=this;t.on("live_ws:"+On.SMT_LOGIN_REPLY,(function(n){var i=n.iCode,o=n.roomInfo;if(0===i){e.roomInfo=o;var r=o.iResourceId,s=o.lWatchSequence,a=o.iStatus;if(a===In.LIVE){var c=Object.assign({},t.liveData,{offset:s,resource:r});t.replayHttp=new hn({liveData:c,eventEmitter:t.eventEmitter}),t.replayHttp.connect(),t.shapeStore=new gn({replayHttp:t.replayHttp}),t.historyStore=new Sn({replayHttp:t.replayHttp}),t.on("replay_http:login_reply",(function(e){e.err&&oe.error("elive http_reply登录失败",e);var n=e.roomInfo;t.emit(qe.FAKE_ROOM_INFO,{name:n.sName,teacher:n.sTeacher}),e.ended?wn(t,In.END):wn(t,In.LIVE)}))}else wn(t,a)}})),t.camera&&t.camera.on("ended",(function(e){wn(t,In.END)})),t.on("live_ws:"+On.SMT_BEGIN_LIVE,(function(e){wn(t,In.LIVE)})),t.on("live_ws:"+On.SMT_END_LIVE,(function(e){wn(t,In.END)})),t.on("live_ws:"+On.SMT_ERROR,(function(e){var n=e.iCode;n===Ln.EC_KICK_BY_ADMIN&&(t.camera&&t.camera.stop(),t.emit(qe.FAKE_ROOM_KICKED,{})),n===Ln.EC_ROOM_REPEAT_LOGIN&&(t.camera&&t.camera.stop(),t.emit(qe.FAKE_ROOM_KICKED_FOR_NEW_LOGIN,{}))})),t.on("live_ws:"+On.SMT_LOGIN_REPLY,(function(e){e.iCode===Ln.EC_KICK_BY_ADMIN&&(t.camera&&t.camera.stop(),t.emit(qe.FAKE_ROOM_KICKED,{}))}))}(this),function(t){t.on("chat_ws:"+Re.SEND_LOGIN_REPLY,(function(e){if(0===e.result){var n=e.data,i=n.forbiddenStatus,o=n.roomAnnounce;t.emit(qe.FAKE_ROOM_CHAT_CONNECTED,e),t.emit(qe.FAKE_ROOM_SPEAKING_UPDATE,{speakingStatus:i}),t.emit(qe.FAKE_ROOM_ANNOUNCE_UPDATE,{announce:o})}})),t.on("chat_ws:"+Re.SPEAKING_CHANGED,(function(e){t.emit(qe.FAKE_ROOM_SPEAKING_UPDATE,{speakingStatus:e.data.status})})),t.on("chat_ws:"+Re.ROOM_ANNOUNCEMENT_UPDATE,(function(e){t.emit(qe.FAKE_ROOM_ANNOUNCE_UPDATE,{announce:e.data.announce})})),t.on("chat_ws:"+Re.MESSAGE_RECV,(function(e){t.emit(qe.FAKE_ROOM_RECV_MSG,e)})),t.on("chat_ws:"+Re.RECEIVE_PRIVATE_MESSAGE,(function(e){t.emit(qe.FAKE_ROOM_RECV_PRIVATE_MSG,e)})),t.on(qe.FAKE_ROOM_KICKED,(function(e){t.chatWS&&t.chatWS.closeWS()})),t.on(qe.FAKE_ROOM_KICKED_FOR_NEW_LOGIN,(function(e){t.chatWS&&t.chatWS.closeWS()}))}(this),this.initLiveWS(),this.initChatWS()},bn.prototype.on=function(t,e){this.eventEmitter.on(t,e,this)},bn.prototype.emit=function(){var t;(t=this.eventEmitter).emit.apply(t,arguments)},Cn.prototype.dispose=function(){this.eventEmitter.removeAllListeners(),this.eventEmitter=null,this.replayHttp&&(this.replayHttp.dispose(),this.replayHttp=null),this.camera&&(this.camera.unmount(),this.camera=null)},Cn.prototype.initCamera=function(t){this.camera=new fn(t),this.camera.mount()},Cn.prototype.connect=function(){var t,e,n;this.replayHttp=new hn({liveData:this.liveData,clipParams:this.clipParams,eventEmitter:this.eventEmitter}),e=(t=this).camera,n=t.replayHttp,t.on("replay_http:login_reply",(function(i){if(!i.err&&e){var o=i.videoPlayUrls.filter((function(t){return"mp4"===t.sFormat}))[0],r=o.sHttpsUrl,s=o.iDuration,a=[{originStartDuration:0,startDuration:0,endDuration:s,duration:s,initSeq:0,url:r,type:1}];e.setVideoList(a),e.load(),e.pause(),e.on("seeked",(function(e){t.emit(qe.VIDEO_CAMERA_SEEKED,e)})),e.on("timeupdate",(function(e){t.emit(qe.VIDEO_CAMERA_TIMEUPDATE,e)})),e.on("ended",(function(e){t.emit(qe.VIDEO_CAMERA_ENDED,e)})),e.on("playing",(function(t){var i=e.isPaused()?1:0;n.updatePlayStatus(i)})),e.on("pause",(function(t){var i=e.isPaused()?1:0;n.updatePlayStatus(i)}))}})),function(t){t.on("replay_http:login_reply",(function(e){if(e.err)oe.error("点播登录遇到错误",e);else{var n=e.roomInfo;t.emit(qe.VIDEO_ROOM_INFO,{name:n.sName,teacher:n.sTeacher})}}))}(this),this.replayHttp.connect()},Cn.prototype.on=function(t,e){this.eventEmitter.on(t,e,this)},Cn.prototype.once=function(t,e){this.eventEmitter.once(t,e,this)},Cn.prototype.emit=function(){var t;(t=this.eventEmitter).emit.apply(t,arguments)};var Rn={"[憨笑]":"hanxiao","[爱慕]":"aimu","[谄媚]":"chanmei","[OK]":"OK","[眩晕]":"xuanyun","[傲娇]":"aojiao","[委屈]":"weiqu","[你好]":"nihao","[帅气]":"shuaiqi","[汗颜]":"hanyan","[胜利]":"shengli","[泪奔]":"leiben","[害羞]":"haixiu","[惊吓]":"jingxia","[么么哒]":"memeda","[生气]":"shengqi","[尴尬]":"ganga","[美]":"mei","[吐血]":"tuxue","[蛋糕]":"dangao","[庆祝]":"qingzhu","[咖啡]":"kafei","[钻石]":"zuanshi","[甜甜圈]":"tiantianquan","[握拳]":"woquan","[送花]":"songhua","[撒花]":"sahua","[冰冻]":"bingdong","[金牌]":"jinpai","[中国好老师]":"zhongguohaolaoshi","[棒棒哒]":"bangbangda","[做鬼脸]":"zuoguilian","[握手]":"woshou","[帅]":"shuai","[心碎]":"xinsui","[嘴唇]":"zuichun","[爱心]":"aixin","[晚安]":"wanan","[钢笔]":"gangbi","[礼物]":"liwu","[疑问]":"yiwen","[我想静静]":"woxiangjingjing","[愤怒]":"fennu","[红包]":"hongbao","[困]":"kun","[强]":"qiang","[太阳]":"taiyang","[惊讶]":"jingya","[弱]":"ruo","[必胜]":"bisheng","[凋谢]":"diaoxie","[打哈欠]":"dahaqie","[耶]":"yeah"};return{LiveRoom:sn,ReplayRoom:Tn,FakeLiveRoom:bn,VideoRoom:Cn,emoji:Object.keys(Rn).reduce((function(t,e){return t[e]="https://assorted.sunlands.com/sl-emoji/"+Rn[e]+".png",t}),{})}}));
